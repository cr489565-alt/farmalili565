<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üì¶ Inventario - FarmaciaLili 3.0 üì¶</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>

body {background:#f4f4f4;color:#000;font-family:system-ui,sans-serif;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;font-size:1.15rem;overflow:hidden;}
header {background:#fff;color:#000;padding:34px;font-size:26px;font-weight:bold;text-align:center;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
header img{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:250px;height:100px;border-radius:25px;border:0px solid #e5e7eb;}
.main-menu {display:flex;align-items:center;padding:10px;background-color:#68af6b;color:white; }
.menu-link {color:white;text-decoration:none;margin-right:15px;}
.main-menu .menu-link {color:#1f2937;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:500;transition:0.2s;border:1px solid #e5e7eb;}
.main-menu .menu-link:hover {background:#fff;color:#111827;}
.main-menu .menu-link.active {background:#2563eb;color:white;border-color:#2563eb;}
#cajero {margin-left:auto;font-weight:bold;color:#000;}
#logout {background:#dc2626;color:#fff;border:none;border-radius:8px;padding:8px 12px;margin-left:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
#logout:hover {background:#b91c1c; dding:8px 12px;border-radius:8px;cursor:pointer;} 

#searchBar { margin-left:10px; padding:8px; border-radius:6px;  }
input,button,select{padding:9px;border-radius:6px;border:1px solid #d1d5db;margin:4px 0;background:#f9fafb;color:#1f2937;}
input,select{width:200px;background:#ffffff;}
button{background:#2563eb;color:white;cursor:pointer;font-weight:bold;border:none;}
button:hover{background:#1d4ed8;}
.btn{padding:0.4rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:0.2s;border:1px solid transparent;}
.btn-edit{background:#2563eb;color:#fff;}
.btn-edit:hover{background:#1e40af;}
.btn-del{background:#dc2626;color:#fff;}
.btn-del:hover{background:#991b1b;}
.btn-pdf{background:#facc15;color:#000;margin-left:5px;}
.btn-pdf:hover{background:#eab308;}
.oculto{display:none;}
.panel-admin{background:#ffffff;border:2px solid #2563eb;padding:1rem;border-radius:12px;margin-bottom:1rem;box-shadow:0 4px 6px rgba(0,0,0,0.05);}
.stock-verde{background:#8cee73;color:#000000;}
.stock-amarillo{background:#f1ef66;color:#000;}
.stock-rojo{background:#f36969;color:#000000;}
.stockmin-rojo{background:#f1ef66;color:#000;}
.entradas-azul{background:#2563eb;color:#000000;}
#tablaEntradasContainer {  flex-grow: 1;  overflow-y: relative;  max-height: 100%;}
.section {  flex: 1;  overflow-x: auto;  border: 1px solid #4f5256;  border-radius: 5px;  background: linear-gradient(rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.4)),
   url('lododoc .png')  no-repeat center center;  background-size: auto;  background-position: auto;  background-attachment: auto;  max-height: 58vh;   min-height: 58vh; box-shadow: inset 0 0 8px rgba(0,0,0,0.2);  display: flex;  flex-direction: column;}
.table  { width: 100%; border-collapse: collapse; margin-top: 0px; table-layout: fixed; min-height: 100%;}
th, td { padding:2px; border-bottom: 1px solid #e5e7eb; text-align: left; word-wrap: break-word;}
th { position: sticky; top: 0; background: #68af6b; color: white; z-index: 10;}
tr:hover { background-color: rgb(66, 252, 59);}
.menu-dropdown{position:relative;display:inline-block;margin-left:10px;}
.menu-btn{background:#2563eb;color:white;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:500;}
.menu-btn:hover{background:#1e40af;}
.dropdown-content{display:none;position:absolute;right:0;background-color:white;min-width:220px;box-shadow:0 4px 10px rgba(0,0,0,0.2);border-radius:8px;z-index:10;}
.dropdown-content button{width:100%;text-align:left;padding:10px;border:none;background:none;color:#111827;cursor:pointer;border-bottom:1px solid #e5e7eb;}
.dropdown-content button:hover{background:#f3f4f6;}
.menu-dropdown.show .dropdown-content{display:block;}
.precio-verde { background:#8cee73;  }
#modalDetalles { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;}
.modal-contenido { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:500px; box-shadow:0 5px 15px rgba(0,0,0,0.3); text-align:left;}
.modal-contenido h3 { margin-top:0; color:#2563eb; }
.modal-contenido p { font-size:15px; margin:6px 0; }
.modal-footer { text-align:right; margin-top:10px; }
</style>
</head>
<body>
<header>
  <img src="lododoc .png" alt="Logo Ventas">
  üì¶ Inventario - FarmaciaLili 3.0 üì¶
</header>

<nav class="main-menu">
  <a href="farma3.html" class="menu-link">üí≥ Ventas</a>
  <a href="inve3.html" class="menu-link active">üì¶ Inventario</a>
  <a href="histori3.html" class="menu-link">üìú Historial</a>
  <input type="text" id="searchBar" placeholder="üîé Buscar...">
  <span id="cajero"></span>

  <div class="menu-dropdown" id="menuOpciones">
    <button class="menu-btn">‚ò∞ Men√∫</button>
    <div class="dropdown-content">
      <button id="btnAdminPanel">‚öôÔ∏è Panel Admin</button>
      <button id="btnSubirInventario">üìä Subir Inventario</button>
      <button id="btnEliminarInventario">‚ùå Eliminar Inventario</button>
      <button id="btnEntradas">‚ûï Entradas</button>
      <button id="btnDescargarCSV">üìÇ DESCARGAR CATEGORIAS CSV</button>
      <button id="btnDescargarPDF">üìÑ DESCARGAR CATEGORIAS  PDF</button>
      <button id="btnDescargarCSVCompleto">üìÅ INVENTARIO COMPLETO CSV</button>
      <button id="btnDescargarPDFCompleto">üìë INVENTARIO COMPLETO PDF</button>
      <button id="logout">üö™ Cerrar Sesi√≥n</button>
    </div>
  </div>
</nav>

<main>
<section id="loginSection" class="oculto">
  <h2>üëë PANEL ADMINISTRACI√ìN üëë</h2>
  üîê Ingresa Contrase√±a
  <form id="loginForm">
    <input type="password" id="adminPass" placeholder="Contrase√±a" required>
    <button type="submit" class="btn btn-edit">Ingresar</button>
  </form>
</section>

<section id="adminSection" class="oculto panel-admin">
  <h2>‚öôÔ∏è Panel Administrador</h2>
  <form id="addForm" style="margin-top:1rem;">
    <h3>‚ûï Agregar / Editar Producto</h3>
    <input type="text" id="nombre" placeholder="Nombre" required>
    <input type="text" id="codigo" placeholder="C√≥digo" required>
    <input type="number" id="precio" placeholder="Precio" step="0.01" required>
    
    <div id="loteCadFields">
        <h4>üß™ Lotes</h4>
        <div id="lotesContainer">
            </div>
        <button type="button" id="agregarLoteBtn" class="btn btn-pdf">‚ûï A√±adir Lote</button>
    </div>
    
    <input type="number" id="stock" placeholder="Stock Total (Cantidad)" min="0" class="oculto" value="0">
    
    <input type="number" id="stockMin" placeholder="M√≠nimo" min="0">
    <input type="number" id="entradas" placeholder="Entradas" class="oculto">
    
    <input type="text" id="categoria" placeholder="Categor√≠a (Ej: Antibi√≥tico)" value="Antibi√≥tico" required>
    
    <div style="margin-top:10px;">
        <button type="submit" class="btn btn-edit">Guardar</button>
        <button type="button" id="salirAdmin" class="btn btn-del">Cancelar</button>
        <button type="button" id="deleteProductBtn" class="btn btn-del oculto">üóëÔ∏è Eliminar Producto</button>
    </div>
  </form>
</section>

<section id="entradasSection" class="oculto panel-admin">
    <h2>‚ûï Registro de Entradas (Existencias F√≠sicas)</h2>
    <form id="formEntradas">
        <input type="text" id="codigoEntrada" placeholder="C√≥digo del Producto" required>
        <input type="number" id="cantidadEntrada" placeholder="Cantidad a sumar" min="1" required>
        <button type="submit" class="btn entradas-azul">Registrar Entrada</button>
        <button type="button" id="salirEntradas" class="btn btn-del">Cancelar</button>
    </form>
    
    <div style="margin-top: 15px;">
        <h3>Historial de Entradas (√öltimas 50)</h3>
        <div class="section">
            <div id="tablaEntradasContainer">
                <table id="tablaEntradas" class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Stock Anterior</th>
                            <th>Entradas</th>
                            <th>Nuevo Stock</th>
                            <th>Cajero</th>
                            <th>Fecha/Hora</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <table id="inventarioTable" class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>C√≥digo</th>
                <th>Producto</th>
                <th>Precio ($)</th>
                <th>Stock Total</th>
                <th>M√≠nimo</th>
                <th>Entradas</th>
                <th>Categor√≠a</th>
                <th>Lotes / Caducidad</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</section>
</main>

<div id="modalDetalles">
  <div class="modal-contenido">
    <h3>Detalles del Producto</h3>
    <div id="detallesContenido">
      </div>
    <div class="modal-footer">
      <button id="cerrarDetalles" class="btn btn-edit">Cerrar</button>
    </div>
  </div>
</div>

<script>
// ---------------------------------------------------------------------------------------------------
// üîπ L√ìGICA DE LA APLICACI√ìN FARMACIALILI 3.0 (INVENTARIO) üîπ
// ---------------------------------------------------------------------------------------------------

// üîë Autenticaci√≥n y Carga Inicial
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(!usuarioActivo){
    window.location.href="index.html";
} else {
    document.getElementById("cajero").textContent = "üë§ Cajero: "+usuarioActivo;
}

// üÜï ESTADO DE SESI√ìN DE ADMINISTRADOR
let isAdminLoggedIn = false; 

// üì¶ Datos de la Aplicaci√≥n (LocalStorage)
function parseJSON(key){
    try{
        return JSON.parse(localStorage.getItem(key)||"[]");
    }catch(e){
        console.warn(`Error al parsear ${key}:`, e);
        return [];
    }
}
function setJSON(key,val){
    localStorage.setItem(key, JSON.stringify(val));
}

let inventario = parseJSON('inventario');
let adminConfig = parseJSON('adminConfig'); 
let entradasHistorial = parseJSON('entradasHistorial');

if (adminConfig.length === 0) {
    adminConfig.push({ password: 'Mariposa' }); // Contrase√±a por defecto
    setJSON('adminConfig', adminConfig);
}

function guardarInventario(){
    setJSON('inventario', inventario);
    renderInventario(inventario);
}
function guardarEntradasHistorial() {
    // Limitar a 50 entradas
    while (entradasHistorial.length > 50) {
        entradasHistorial.shift(); 
    }
    setJSON('entradasHistorial', entradasHistorial);
    renderEntradasHistorial();
}

// ---------------------------------------------------------------------------------------------------
// üñºÔ∏è Renderizado de Inventario
// ---------------------------------------------------------------------------------------------------

/**
 * Calcula el stock total para un producto.
 * @param {object} producto - El objeto producto.
 * @returns {number} El stock total.
 */
function calcularStockTotal(producto) {
    // Si tiene lotes (debe ser Antibi√≥tico), suma los stocks de los lotes
    if (producto.categoria.toLowerCase() === 'antibi√≥tico' && producto.lotes && producto.lotes.length > 0) {
        return producto.lotes.reduce((sum, lote) => sum + (lote.stock || 0), 0);
    }
    // Si no tiene lotes (otras categor√≠as), usa el campo stock simple
    return producto.stock || 0; 
}

/**
 * Renderiza la tabla de inventario.
 * @param {Array<object>} productos - Lista de productos a mostrar.
 */
function renderInventario(productos) {
    const tbody = document.getElementById('inventarioTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    productos.forEach((producto, index) => {
        const stockTotal = calcularStockTotal(producto);
        const row = tbody.insertRow();
        
        let stockClass = '';
        if (stockTotal <= 0) {
            stockClass = 'stock-rojo'; // Agotado
        } else if (stockTotal <= producto.stockMin) {
            stockClass = 'stock-amarillo'; // M√≠nimo
        } else {
            stockClass = 'stock-verde'; // Stock Ok
        }

        row.insertCell(0).textContent = index + 1;
        row.insertCell(1).textContent = producto.codigo;
        row.insertCell(2).textContent = producto.nombre;
        
        const precioCell = row.insertCell(3);
       precioCell.textContent = '$' + (Number(producto.precio) || 0).toFixed(2);
        const stockCell = row.insertCell(4);
        stockCell.textContent = stockTotal;
        stockCell.className = stockClass;

        row.insertCell(5).textContent = producto.stockMin;
        row.insertCell(6).textContent = producto.entradas || 0;
        row.insertCell(7).textContent = producto.categoria;
        
        const lotesCell = row.insertCell(8);
        const esAntibiotico = producto.categoria.toLowerCase() === 'antibi√≥tico';

        if (esAntibiotico && producto.lotes && producto.lotes.length > 0) {
            const lotesActivos = producto.lotes.filter(l => (l.stock || 0) > 0);
            if (lotesActivos.length > 0) {
                 // Mostrar caducidad m√°s pr√≥xima
                const caducidadMasProxima = lotesActivos.sort((a, b) => new Date(a.caducidad) - new Date(b.caducidad))[0];
                lotesCell.textContent = `Cad. Prox: ${new Date(caducidadMasProxima.caducidad).toLocaleDateString()} (${lotesActivos.length} lotes)`;
            } else {
                 lotesCell.textContent = 'Lotes Registrados (Stock 0)';
            }
        } else {
            lotesCell.textContent = 'N/A';
        }

        // Acciones
        const actionsCell = row.insertCell(9);
        
        // üëÅÔ∏è Bot√≥n Detalles: Solo para Antibi√≥ticos
        if (esAntibiotico) {
            const btnDetalles = document.createElement('button');
            btnDetalles.textContent = 'üëÅÔ∏è Detalles';
            btnDetalles.className = 'btn';
            btnDetalles.onclick = () => mostrarDetalles(producto);
            actionsCell.appendChild(btnDetalles);
        }
        
        // üÜï BOT√ìN EDITAR: Solo visible si el administrador ha iniciado sesi√≥n
        if (isAdminLoggedIn) {
            const btnEditar = document.createElement('button');
            btnEditar.textContent = '‚úçÔ∏è';
            btnEditar.className = 'btn btn-edit';
            btnEditar.onclick = () => editarProducto(producto.codigo);
            actionsCell.appendChild(btnEditar);
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    renderInventario(inventario);
    renderEntradasHistorial();
    // Inicializar la visibilidad de lotes/stock en el panel admin al cargar
    toggleLoteFields(); 
});

// ---------------------------------------------------------------------------------------------------
// üîç B√∫squeda en Inventario
// ---------------------------------------------------------------------------------------------------
document.getElementById('searchBar').addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    
    if (query === '') {
        renderInventario(inventario);
        return;
    }

    const resultados = inventario.filter(p => 
        p.codigo.toLowerCase().includes(query) || 
        p.nombre.toLowerCase().includes(query) ||
        p.categoria.toLowerCase().includes(query)
    );

    renderInventario(resultados);
});

// ---------------------------------------------------------------------------------------------------
// üëÅÔ∏è Modal de Detalles de Producto
// ---------------------------------------------------------------------------------------------------
const modalDetalles = document.getElementById('modalDetalles');

function mostrarDetalles(producto) {
    // Solo se muestra para Antibi√≥ticos (l√≥gica en renderInventario)

    const detallesContenido = document.getElementById('detallesContenido');
    detallesContenido.innerHTML = `
        <p><strong>Nombre:</strong> ${producto.nombre}</p>
        <p><strong>C√≥digo:</strong> ${producto.codigo}</p>
        <p><strong>Precio:</strong> $${producto.precio.toFixed(2)}</p>
        <p><strong>Stock Total:</strong> ${calcularStockTotal(producto)}</p>
        <p><strong>Stock M√≠nimo:</strong> ${producto.stockMin}</p>
        <p><strong>Categor√≠a:</strong> ${producto.categoria}</p>
        <h4>üß™ Lotes Activos (Stock > 0)</h4>
    `;

    // Ordenar lotes por caducidad (m√°s cercano primero)
    const lotesActivos = producto.lotes 
        ? producto.lotes.filter(l => (l.stock || 0) > 0).sort((a, b) => new Date(a.caducidad) - new Date(b.caducidad)) 
        : [];
        
    if (lotesActivos.length > 0) {
        lotesActivos.forEach(lote => {
            detallesContenido.innerHTML += `
                <p style="margin-left: 10px;">
                    - Lote: <strong>${lote.lote}</strong> | Stock: ${lote.stock} | Caduca: ${new Date(lote.caducidad).toLocaleDateString()}
                </p>
            `;
        });
    } else {
         detallesContenido.innerHTML += `<p style="margin-left: 10px;">No hay lotes activos.</p>`;
    }

    modalDetalles.style.display = 'flex';
}

document.getElementById('cerrarDetalles').onclick = () => {
    modalDetalles.style.display = 'none';
};


// ---------------------------------------------------------------------------------------------------
// ‚öôÔ∏è Panel de Administraci√≥n (CRUD y L√≥gica de Lotes)
// ---------------------------------------------------------------------------------------------------
const loginSection = document.getElementById('loginSection');
const adminSection = document.getElementById('adminSection');
const form = document.getElementById('addForm');
const codigoInput = document.getElementById('codigo');
let productoAEditar = null; 

// Campos relacionados a la l√≥gica de categor√≠as
const categoriaInput = document.getElementById('categoria');
const stockInput = document.getElementById('stock');
const loteCadFields = document.getElementById('loteCadFields');

/**
 * Muestra u oculta los campos de Lote y Stock basado en si la categor√≠a es "Antibi√≥tico".
 */
function toggleLoteFields() {
    const categoria = categoriaInput.value.trim().toLowerCase();
    
    if (categoria === 'antibi√≥tico') {
        loteCadFields.classList.remove('oculto');
        stockInput.classList.add('oculto');
        
        // Si estamos agregando o editando un antibi√≥tico sin lotes, a√±adimos uno vac√≠o.
        if (lotesContainer.children.length === 0) {
            document.getElementById('agregarLoteBtn').click(); 
        }
    } else {
        loteCadFields.classList.add('oculto');
        stockInput.classList.remove('oculto');
        
        // Limpiar lotes del formulario para evitar guardar datos incorrectos
        lotesContainer.innerHTML = '';
    }
}

// ‚ö†Ô∏è Se activa la funci√≥n al cambiar la categor√≠a
categoriaInput.addEventListener('input', toggleLoteFields);


// üîë Manejo de Login Admin (Acceder a Panel)
document.getElementById('btnAdminPanel').onclick = () => {
    document.getElementById('btnAdminPanel').parentNode.classList.remove('show');
    loginSection.style.display = 'block';
    adminSection.style.display = 'none';
    document.getElementById('entradasSection').style.display = 'none';

    accionPendiente = () => {
        adminSection.style.display = 'block';
        limpiarFormularioAdmin();
    };
};

document.getElementById('salirAdmin').onclick = () => {
    adminSection.style.display = 'none';
    loginSection.style.display = 'none';
    limpiarFormularioAdmin();
    
    // üÜï Desactivar estado Admin y re-renderizar
    isAdminLoggedIn = false; 
    renderInventario(inventario);
};

/**
 * Limpia el formulario y lo pone en modo "Agregar".
 */
function limpiarFormularioAdmin() {
    form.reset();
    productoAEditar = null;
    codigoInput.removeAttribute('readonly');
    document.getElementById('deleteProductBtn').classList.add('oculto');
    document.getElementById('lotesContainer').innerHTML = ''; 
    
    // Establecer el estado inicial de Lote/Stock (por defecto "Antibi√≥tico")
    categoriaInput.value = 'Antibi√≥tico';
    toggleLoteFields(); 
}

// üß™ L√≥gica de Lotes en el Formulario Admin
const lotesContainer = document.getElementById('lotesContainer');

document.getElementById('agregarLoteBtn').onclick = () => {
    const loteDiv = document.createElement('div');
    loteDiv.className = 'lote-entry';
    loteDiv.style.marginBottom = '10px';
    loteDiv.innerHTML = `
        <label>Lote:</label><input type="text" class="lote-id" placeholder="ID Lote" required>
        <label>Stock:</label><input type="number" class="lote-stock" placeholder="Stock" min="0" required value="0" style="width: 80px;">
        <label>Caducidad:</label><input type="date" class="lote-caducidad" required style="width: 120px;">
        <button type="button" class="btn btn-del" onclick="this.parentNode.remove()">‚ùå</button>
    `;
    lotesContainer.appendChild(loteDiv);
};

// ‚úçÔ∏è Cargar datos del producto para editar
function editarProducto(codigo) {
    // Si no est√° logueado como admin, simplemente ignora la acci√≥n.
    if (!isAdminLoggedIn) return alert("Acceso denegado. Debe ingresar al Panel Administrador para editar productos.");

    productoAEditar = inventario.find(p => p.codigo === codigo);
    
    if (productoAEditar) {
        // Asumiendo que si el usuario hace clic en editar, tiene acceso de administrador
        loginSection.style.display = 'none';
        adminSection.style.display = 'block';
        document.getElementById('deleteProductBtn').classList.remove('oculto');

        // Llenar campos
        document.getElementById('nombre').value = productoAEditar.nombre;
        codigoInput.value = productoAEditar.codigo;
        codigoInput.setAttribute('readonly', true);
        document.getElementById('precio').value = productoAEditar.precio;
        document.getElementById('stockMin').value = productoAEditar.stockMin;
        categoriaInput.value = productoAEditar.categoria;
        
        // Cargar Lotes / Stock Simple
        lotesContainer.innerHTML = '';
        const esAntibiotico = productoAEditar.categoria.toLowerCase() === 'antibi√≥tico';

        if (esAntibiotico && productoAEditar.lotes && productoAEditar.lotes.length > 0) {
            productoAEditar.lotes.forEach(lote => {
                const loteDiv = document.createElement('div');
                loteDiv.className = 'lote-entry';
                loteDiv.style.marginBottom = '10px';
                loteDiv.innerHTML = `
                    <label>Lote:</label><input type="text" class="lote-id" value="${lote.lote}" placeholder="ID Lote" required>
                    <label>Stock:</label><input type="number" class="lote-stock" value="${lote.stock}" placeholder="Stock" min="0" required style="width: 80px;">
                    <label>Caducidad:</label><input type="date" class="lote-caducidad" value="${lote.caducidad}" required style="width: 120px;">
                    <button type="button" class="btn btn-del" onclick="this.parentNode.remove()">‚ùå</button>
                `;
                lotesContainer.appendChild(loteDiv);
            });
        } else if (esAntibiotico) {
            document.getElementById('agregarLoteBtn').click();
        } 
        
        if (!esAntibiotico) {
            stockInput.value = calcularStockTotal(productoAEditar);
        }
        
        toggleLoteFields(); 
    }
}

// üóëÔ∏è Eliminar Producto
document.getElementById('deleteProductBtn').onclick = () => {
    if (productoAEditar && confirm(`¬øEst√° seguro de eliminar el producto ${productoAEditar.nombre} (${productoAEditar.codigo})?`)) {
        inventario = inventario.filter(p => p.codigo !== productoAEditar.codigo);
        guardarInventario();
        limpiarFormularioAdmin();
        alert('Producto eliminado.');
    }
};

// üíæ Guardar Producto (Agregar/Editar)
form.onsubmit = (e) => {
    e.preventDefault();

    const nombre = document.getElementById('nombre').value;
    const codigo = codigoInput.value;
    const precio = parseFloat(document.getElementById('precio').value);
    const stockMin = parseInt(document.getElementById('stockMin').value);
    const categoria = categoriaInput.value;
    
    let lotes = [];
    let stockTotal = 0;
    const esAntibiotico = categoria.toLowerCase() === 'antibi√≥tico';

    if (esAntibiotico) {
        // L√≥gica para ANTIBI√ìTICOS (con lotes)
        const loteEntries = document.querySelectorAll('.lote-entry');
        
        loteEntries.forEach(entry => {
            const id = entry.querySelector('.lote-id').value;
            const stock = parseInt(entry.querySelector('.lote-stock').value);
            const caducidad = entry.querySelector('.lote-caducidad').value;
            
            if (id && caducidad && !isNaN(stock) && stock >= 0) {
                lotes.push({ lote: id, stock: stock, caducidad: caducidad });
                stockTotal += stock; 
            }
        });

        if (lotes.length === 0) {
            return alert('Debe agregar al menos un lote con ID, Stock y Caducidad para productos Antibi√≥ticos.');
        }

    } else {
        // L√≥gica para OTRAS CATEGOR√çAS (sin lotes, usando stock simple)
        const simpleStock = parseInt(stockInput.value);
        if (isNaN(simpleStock) || simpleStock < 0) {
            return alert('Ingrese un Stock Total v√°lido para esta categor√≠a.');
        }
        stockTotal = simpleStock;
        lotes = []; // Asegurar que no se guarde ning√∫n lote
    }

    const nuevoProducto = {
        nombre,
        codigo,
        precio,
        stockMin,
        categoria,
        lotes: lotes,
        entradas: productoAEditar ? productoAEditar.entradas : 0, 
        stock: stockTotal 
    };

    if (productoAEditar) {
        // Editar
        const index = inventario.findIndex(p => p.codigo === codigo);
        inventario[index] = nuevoProducto;
        alert('Producto actualizado.');
    } else {
        // Agregar
        if (inventario.some(p => p.codigo === codigo)) {
            return alert('Ya existe un producto con este c√≥digo.');
        }
        inventario.push(nuevoProducto);
        alert('Producto agregado.');
    }

    guardarInventario();
    limpiarFormularioAdmin();
};

// ---------------------------------------------------------------------------------------------------
// üîë L√≥gica de Acceso para funciones sensibles
// ---------------------------------------------------------------------------------------------------

let accionPendiente = null; 

document.getElementById('loginForm').onsubmit = (e) => {
    e.preventDefault();
    const pass = document.getElementById('adminPass').value;
    
    if (pass === adminConfig[0].password) {
        loginSection.style.display = 'none';
        
        // üÜï Activar estado Admin y re-renderizar
        isAdminLoggedIn = true; 
        renderInventario(inventario); 
        
        if (accionPendiente) {
            accionPendiente(); 
        }
        
    } else {
        alert('Contrase√±a incorrecta.');
    }
    
    document.getElementById('adminPass').value = '';
    accionPendiente = null;
};

function ejecutarSubirInventario() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const csvContent = event.target.result;
                const newInventario = importarCSV(csvContent);
                
                if (newInventario.length > 0 && confirm(`Se encontraron ${newInventario.length} productos en el CSV. ¬øDesea reemplazar el inventario actual con estos datos?`)) {
                    inventario = newInventario;
                    guardarInventario();
                    alert('Inventario cargado y reemplazado con √©xito.');
                } else if (newInventario.length === 0) {
                     alert('El archivo CSV est√° vac√≠o o tiene un formato incorrecto.');
                }

            } catch (error) {
                alert(`Error al procesar el archivo: ${error.message}`);
                console.error(error);
            }
        };
        reader.readAsText(file);
    };
    fileInput.click();
}

function ejecutarEliminarInventario() {
     if (confirm("CONFIRMACI√ìN FINAL: ¬øEst√° absolutamente seguro de borrar TODOS los datos del inventario? Esta acci√≥n es irreversible.")) {
        inventario = [];
        guardarInventario();
        alert('Inventario eliminado por completo.');
    }
}

// Botones que requieren contrase√±a (Subir y Eliminar)
document.getElementById('btnSubirInventario').onclick = () => {
    document.getElementById('btnSubirInventario').parentNode.classList.remove('show');
    adminSection.style.display = 'none';
    document.getElementById('entradasSection').style.display = 'none';

    accionPendiente = ejecutarSubirInventario;
    loginSection.style.display = 'block';
};

document.getElementById('btnEliminarInventario').onclick = () => {
    document.getElementById('btnEliminarInventario').parentNode.classList.remove('show');
    adminSection.style.display = 'none';
    document.getElementById('entradasSection').style.display = 'none';
    
    accionPendiente = ejecutarEliminarInventario;
    loginSection.style.display = 'block';
};


// ---------------------------------------------------------------------------------------------------
// ‚ûï Registro de Entradas (Existencias F√≠sicas)
// ---------------------------------------------------------------------------------------------------

document.getElementById('btnEntradas').onclick = () => {
    document.getElementById('btnEntradas').parentNode.classList.remove('show');
    adminSection.style.display = 'none';
    loginSection.style.display = 'none';
    document.getElementById('entradasSection').style.display = 'block';
};

document.getElementById('salirEntradas').onclick = () => {
    document.getElementById('entradasSection').style.display = 'none';
};

/**
 * Renderiza la tabla de historial de entradas.
 */
function renderEntradasHistorial() {
    const tbody = document.getElementById('tablaEntradas').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    
    // Mostrar las √∫ltimas 50, en orden cronol√≥gico inverso (m√°s recientes primero)
    entradasHistorial.slice().reverse().forEach((entrada, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = entradasHistorial.length - index;
        row.insertCell(1).textContent = entrada.codigo;
        row.insertCell(2).textContent = entrada.nombre;
        
        // Stock Anterior
        row.insertCell(3).textContent = entrada.stockAnterior !== undefined ? entrada.stockAnterior : 'N/A';
        
        // Entradas (Cantidad)
        const cantCell = row.insertCell(4);
        cantCell.textContent = `+${entrada.cantidad}`;
        cantCell.className = 'entradas-azul';
        
        // Nuevo Stock
        row.insertCell(5).textContent = entrada.nuevoStock !== undefined ? entrada.nuevoStock : 'N/A';
        
        row.insertCell(6).textContent = entrada.cajero;
        row.insertCell(7).textContent = new Date(entrada.fecha).toLocaleString();
    });
}

document.getElementById('formEntradas').onsubmit = (e) => {
    e.preventDefault();
    
    const codigo = document.getElementById('codigoEntrada').value.trim();
    const cantidad = parseInt(document.getElementById('cantidadEntrada').value);
    
    if (cantidad <= 0 || isNaN(cantidad)) {
        return alert('La cantidad debe ser un n√∫mero positivo.');
    }
    
    const producto = inventario.find(p => p.codigo === codigo);
    
    if (!producto) {
        return alert('Producto no encontrado.');
    }
    
    const esAntibiotico = producto.categoria.toLowerCase() === 'antibi√≥tico';

    // 1. Capturar el Stock Anterior (calculado correctamente para lotes o simple stock)
    const stockAnterior = calcularStockTotal(producto);
    
    let nuevoStock;

    if (esAntibiotico) {
        if (!producto.lotes || producto.lotes.length === 0) {
            return alert('Este producto es Antibi√≥tico y requiere Lotes. Edite el producto en el Panel Admin y asigne un lote antes de registrar una entrada.');
        }

        // Si es Antibi√≥tico, pedimos el Lote
        const loteSeleccionado = prompt(`Producto: ${producto.nombre}\nLotes disponibles: ${producto.lotes.map(l => `${l.lote} (Stock: ${l.stock})`).join(', ')}\n\nIngrese el ID del Lote al que sumar√° ${cantidad} unidades:`);
        
        if (loteSeleccionado) {
            const lote = producto.lotes.find(l => l.lote === loteSeleccionado);
            
            if (!lote) {
                return alert('Lote no encontrado para este producto. Verifique el ID del lote.');
            }

            lote.stock += cantidad; // Sumar al stock del lote
            alert(`Entrada de ${cantidad} unidades registrada con √©xito al Lote ${loteSeleccionado} del producto ${producto.nombre}.`);
            
            // Calcular el Nuevo Stock para el historial
            nuevoStock = calcularStockTotal(producto); 
        } else {
            return; // Cancelado por el usuario
        }
    } else {
        // Si no es Antibi√≥tico, sumamos al stock simple
        producto.stock = (producto.stock || 0) + cantidad;
        alert(`Entrada de ${cantidad} unidades registrada con √©xito al stock del producto ${producto.nombre}.`);
        
        // El nuevo stock es el producto.stock actualizado
        nuevoStock = producto.stock;
    }

    // 2. Registrar la entrada en el historial con Stock Anterior y Nuevo Stock
    const entradaData = {
        codigo: codigo,
        nombre: producto.nombre,
        stockAnterior: stockAnterior, 
        cantidad: cantidad,
        nuevoStock: nuevoStock, 
        fecha: new Date().toISOString(),
        cajero: usuarioActivo
    };
    entradasHistorial.push(entradaData);
    
    // 3. Guardar
    producto.entradas = (producto.entradas || 0) + cantidad; // Actualizar el contador de entradas totales
    guardarInventario(); 
    guardarEntradasHistorial();
    
    document.getElementById('formEntradas').reset();
};

// ---------------------------------------------------------------------------------------------------
// üìä Importar/Exportar (CSV/PDF)
// ---------------------------------------------------------------------------------------------------

/**
 * Procesa el contenido de un CSV y lo convierte en el formato de inventario.
 * @param {string} csv - Contenido del archivo CSV.
 * @returns {Array<object>} Nuevo array de inventario.
 */
function importarCSV(csv) {
    const lines = csv.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) return [];

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const productos = [];

    // Definir los √≠ndices esperados (basado en el orden de exportaci√≥n)
    const indices = {
        nombre: headers.indexOf('nombre'),
        codigo: headers.indexOf('c√≥digo'),
        precio: headers.indexOf('precio'),
        stock_simple: headers.indexOf('stock'), 
        stockmin: headers.indexOf('m√≠nimo'),
        categoria: headers.indexOf('categor√≠a'),
        lotes: headers.indexOf('lotes/caducidad')
    };
    
    // Funci√≥n auxiliar para obtener el valor limpio de una columna
    function getCleanValue(values, index) {
        const val = (values[index] || '').trim();
        return val.startsWith('"') && val.endsWith('"') ? val.slice(1, -1).trim() : val;
    }

    for (let i = 1; i < lines.length; i++) {
        // Uso de una expresi√≥n regular simple para manejar campos entre comillas
        const values = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
        
        // Limpiamos los valores de comillas dobles que persisten
        const cleanedValues = values.map(v => getCleanValue([v], 0));
        
        if (cleanedValues.length < 6) continue;

        const categoriaImportada = cleanedValues[indices.categoria] || 'General';
        const esAntibiotico = categoriaImportada.toLowerCase() === 'antibi√≥tico';
        let lotes = [];
        let stockTotal = 0;
        
        if (esAntibiotico) {
            // L√ìGICA ANTIBI√ìTICO (REQUIERE LOTES)
            const lotesRaw = cleanedValues[indices.lotes] || '';
            // Formato esperado de lotes: "LoteID/Stock/Caducidad|LoteID/Stock/Caducidad"
            lotesRaw.split('|').forEach(loteStr => {
                const parts = loteStr.split('/');
                if (parts.length === 3) {
                    const [loteId, stockStr, caducidad] = parts;
                    const stock = parseInt(stockStr);
                    if (loteId && !isNaN(stock) && stock >= 0 && caducidad) {
                        lotes.push({ lote: loteId.trim(), stock: stock, caducidad: caducidad.trim() });
                        stockTotal += stock; // Sumar stock total de lotes
                    }
                }
            });
        } else {
            // L√ìGICA OTRAS CATEGOR√çAS (USA STOCK SIMPLE)
            const stockSimple = parseFloat(cleanedValues[indices.stock_simple] || 0);
            stockTotal = stockSimple; 
            lotes = []; // Asegurar que no haya lotes para esta categor√≠a
        }


        productos.push({
            nombre: cleanedValues[indices.nombre],
            codigo: cleanedValues[indices.codigo],
            precio: parseFloat(cleanedValues[indices.precio] || 0),
            stockMin: parseInt(cleanedValues[indices.stockmin] || 0),
            categoria: categoriaImportada,
            lotes: lotes,
            entradas: 0, 
            stock: stockTotal 
        });
    }

    return productos;
}

// üìÇ Descargar Inventario CSV Completo
document.getElementById('btnDescargarCSVCompleto').onclick = () => {
    document.getElementById('btnDescargarCSVCompleto').parentNode.classList.remove('show');
    descargarCSV(inventario, 'Inventario_Completo');
};

// üìÅ Descargar Inventario PDF Completo
document.getElementById('btnDescargarPDFCompleto').onclick = () => {
    document.getElementById('btnDescargarPDFCompleto').parentNode.classList.remove('show');
    descargarPDF(inventario, 'Inventario_Completo');
};

// üìÇ Descargar por Categor√≠a CSV (Pide Categor√≠a)
document.getElementById('btnDescargarCSV').onclick = () => {
    document.getElementById('btnDescargarCSV').parentNode.classList.remove('show');
    descargarPorCategoria('csv');
};

// üìÑ Descargar por Categor√≠a PDF (Pide Categor√≠a)
document.getElementById('btnDescargarPDF').onclick = () => {
    document.getElementById('btnDescargarPDF').parentNode.classList.remove('show');
    descargarPorCategoria('pdf');
};

function descargarPorCategoria(tipo) {
    const categoria = prompt('Ingrese la Categor√≠a a exportar (ej: Antibi√≥tico, Analg√©sico):').trim();
    if (!categoria) return;

    const productosFiltrados = inventario.filter(p => p.categoria.toLowerCase() === categoria.toLowerCase());

    if (productosFiltrados.length === 0) {
        return alert(`No se encontraron productos en la categor√≠a "${categoria}".`);
    }

    if (tipo === 'csv') {
        descargarCSV(productosFiltrados, `Inventario_${categoria}`);
    } else {
        descargarPDF(productosFiltrados, `Inventario_${categoria}`);
    }
}

/**
 * Genera y descarga un archivo CSV.
 * @param {Array<object>} productos - Lista de productos.
 * @param {string} filename - Nombre base del archivo.
 */
function descargarCSV(productos, filename) {
    let csv = 'C√≥digo,Nombre,Precio,Stock,M√≠nimo,Entradas,Categor√≠a,Lotes/Caducidad\n';

    productos.forEach(p => {
        const stockTotal = calcularStockTotal(p);
        const esAntibiotico = p.categoria.toLowerCase() === 'antibi√≥tico';
        
        // Formato de Lotes para CSV: LoteID/Stock/Caducidad|LoteID/Stock/Caducidad
        const lotesDetalle = esAntibiotico && p.lotes && p.lotes.length > 0
            ? p.lotes.map(l => `${l.lote}/${l.stock}/${l.caducidad}`).join('|')
            : 'N/A'; // N/A si no es antibi√≥tico o si el antibi√≥tico no tiene lotes

        csv += `${p.codigo},"${p.nombre.replace(/"/g, '""')}",${p.precio.toFixed(2)},${stockTotal},${p.stockMin},${p.entradas || 0},"${p.categoria.replace(/"/g, '""')}",${lotesDetalle}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', `${filename}_${new Date().toISOString().slice(0, 10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/**
 * Genera y descarga un archivo PDF (Requiere jsPDF).
 * @param {Array<object>} productos - Lista de productos.
 * @param {string} filename - Nombre base del archivo.
 */
function descargarPDF(productos, filename) {
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        alert("Error: jsPDF no est√° cargado. Aseg√∫rese de que las librer√≠as CDN est√©n funcionando.");
        return;
    }
    
    // @ts-ignore
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF('landscape'); 
    
    doc.setFontSize(14);
    doc.text(`Inventario ${filename.replace('Inventario_','')}`, 14, 15);
    doc.setFontSize(10);
    doc.text(`Fecha de Exportaci√≥n: ${new Date().toLocaleDateString()}`, 14, 20);

    const rows = productos.map((p,i)=>{
        const stockTotal = calcularStockTotal(p);
        const esAntibiotico = p.categoria.toLowerCase() === 'antibi√≥tico';

        // Detalle de lotes para PDF
        const lotesDetalle = esAntibiotico && p.lotes && p.lotes.length > 0
            ? p.lotes.map(l => {
                const fechaCad = new Date(l.caducidad).toLocaleDateString();
                return `Lote: ${l.lote} | Stock: ${l.stock} | Cad: ${fechaCad}`;
            }).join('\n')
            : 'N/A';

        return [
            i+1, 
            p.codigo, 
            p.nombre, 
            '$'+p.precio.toFixed(2), 
            stockTotal, 
            p.stockMin, 
            p.entradas || 0, 
            p.categoria, 
            lotesDetalle
        ]
    });

    doc.autoTable({ 
        head:[['#','C√≥digo','Nombre','Precio','Stock','M√≠nimo','Entradas','Categor√≠a','Lotes / Caducidad']], 
        body: rows, 
        startY:25,
        styles: { overflow: 'linebreak', fontSize: 8 },
        columnStyles: {
            2: { cellWidth: 30 }, // Nombre
            8: { cellWidth: 50 }  // Lotes/Caducidad
        }
    });

    doc.save(`${filename}_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// ---------------------------------------------------------------------------------------------------
// üö™ Cierre de Sesi√≥n
// ---------------------------------------------------------------------------------------------------
document.getElementById('logout').onclick = () => {
    localStorage.removeItem("usuarioActivo");
    // üÜï Desactivar estado Admin al cerrar sesi√≥n
    isAdminLoggedIn = false; 
    window.location.href = "index.html";
};

// ---------------------------------------------------------------------------------------------------
// ‚ò∞ Dropdown Men√∫
// ---------------------------------------------------------------------------------------------------
document.querySelector('#menuOpciones .menu-btn').onclick = function() {
    document.getElementById('menuOpciones').classList.toggle('show');
};

window.onclick = function(event) {
    if (!event.target.matches('.menu-btn')) {
        const dropdowns = document.getElementsByClassName("menu-dropdown");
        for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
};

</script>
</body>
</html>


