<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> 💳 Ventas - FarmaciaLili 2.0 💳 </title>
<style>
 body {background:#f4f4f4;color: #1f2937;font-family: system-ui, sans-serif;  margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-size: 1.15rem; overflow: hidden;}
 header { background:#ffffff;  color:#000000;  padding: 30px; font-size: 26px; font-weight: bold; text-align: center; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        header img { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:150px; height:90px; border-radius:25px; border: 0px solid #e5e7eb; }
        main { padding:16px; display:flex; flex-direction:column; gap:16px; }
        .main-menu { display: flex; align-items: center; padding: 10px; background-color: #68af6b; color: white; }
        .menu-link { color: white; text-decoration: none; margin-right: 15px; }
        .main-menu .menu-link { color:#1f2937; text-decoration:none; padding:8px 12px; border-radius:8px; font-weight:500; transition:0.2s; border: 1px solid #e5e7eb; }
        .main-menu .menu-link:hover { background:#ffffff; color:#111827; }
        .main-menu .menu-link.active { background:#2563eb; color:white; border-color: #2563eb; }
#cajero { margin-left:auto; font-weight:bold; color:#000000; }
#logout { background:#dc2626; color:#fff; border:none; border-radius:8px; padding:8px 12px; margin-left:12px; cursor:pointer; font-weight:bold; transition:0.2s;}
#logout:hover { background:#b91c1c; }
main { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden;}
#ventaCard { background: #ffffff; border-radius: 16px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; display: flex; flex-direction: column; height: 100%;}
#searchProducto { margin-bottom: 5px; padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid #d1d5db;}
.tabla-contenedor {flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #4f5256; border-radius: 5px; background:  linear-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.4)), 
   url('lododoc .png') no-repeat center center; background-size: auto;  background-position: center;  background-attachment: fixed; max-height: 55vh; box-shadow: inset 0 0 8px rgba(0,0,0,0.2);}
table { width: 100%; border-collapse: collapse; font-size: 1rem; table-layout: fixed;}
th, td { padding:2px; border-bottom: 1px solid #e5e7eb; text-align: left; word-wrap: break-word;}
th { position: sticky; top: 0; background: #68af6b; color: white; z-index: 10;}
.status-ok { background: #03e521; }
.status-proximo { background: #f6ff00; }
.status-caducado { background: #ff0000d8; }
input, select, button {padding:8px; border-radius:6px; border:1px solid #2563eb; margin:4px 0; }
input[readonly] { background:#f3f4f6; color:#6b7280; }
button { cursor:pointer; font-weight:bold; transition:0.2s; }
#btnCobrar { margin-top: 6px; background-color: rgb(64,255,0); }
#btnReembolso { margin-top: 6px; background-color: red; color:white; }
#clienteForm, #folioProveedorDiv {display:none; flex-wrap:wrap; gap:4px; margin-top:5px;}
#clienteForm input, #folioProveedorDiv input { flex:1; }
#panelReembolso { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:2000;}
#panelReembolso .contenido { background:#fff; padding:1px; border-radius:16px; width:420px; display:flex; flex-direction:column; gap:12px; box-shadow:0 4px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease-in-out;}
#panelReembolso h3 { margin:0; color:#2563eb; text-align:center; }
#panelReembolso button { padding:1px; border-radius:8px; font-weight:bold; cursor:pointer; }
#btnFinalizar { background:red; color:white; }
#btnCancelar { background:yellow; color:black; }
@keyframes fadeIn { from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);} }
/* Estilo adicional para el selector de lotes */
.lote-selector { width: 100%; padding: 4px; font-size: 0.9em;}
.cantidad-input { width: 60px; padding: 4px; font-size: 0.9em; margin-right: 5px;}
</style>
</head>
<body>
<header>
  <img src="lododoc .png" alt="Logo Ventas">
  💳 Ventas - FarmaciaLili 2.0 💳
</header>

<nav class="main-menu">
  <a href="farma2.html" class="menu-link active">💳 Ventas</a>
  <a href="inve2.html" class="menu-link">📦 Inventario</a>
  <a href="histori2.html" class="menu-link">📜 Historial</a>
  <span id="cajero"></span>
  <button id="logout">Cerrar Sesión</button>
</nav>

<main>
  <div id="ventaCard">
    <input type="text" id="searchProducto" placeholder="Escanea o escribe código/nombre">
    <div class="tabla-contenedor">
      <table id="tablaVenta">
        <thead>
          <tr>
            <th>Descripcion</th><th>Código</th><th>Categoría</th><th>Cant.</th><th>Precio</th>
            <th>Subtotal</th><th>Caducidad</th><th>Lote</th><th>Status / Stock</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="totalVenta">Total: $0.00</p>

    <div id="clienteForm">
      <input type="text" id="clienteNombre" placeholder="Nombre del Doctor">
      <input type="text" id="clienteCedula" placeholder="Cédula profesional" maxlength="8">
      <input type="text" id="clienteDireccion" placeholder="Dirección">
      <input type="text" id="folioReceta" placeholder="Folio de receta" maxlength="8">
    </div>

    <div id="folioProveedorDiv">
      <input type="text" id="folioProveedor" placeholder="Folio del proveedor">

    </div>

    <div id="pagoForm">
      <input type="number" id="pagoInput" placeholder="Pago recibido" min="0">
      <input type="text" id="cambioDisplay" placeholder="Cambio" readonly>
       <select id="metodoPago">
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Proveedores">Provedores</option>
      </select>
    </div>

    <button id="btnCobrar">Cobrar</button>
    <button id="btnReembolso">Reembolso</button>
  </div>
</main>

<div id="panelReembolso">
  <div class="contenido">
    <h3>Reembolso</h3>
    <select id="folioVentaSelect" placeholder="Selecciona el folio de la venta">
      <option value="">-- Selecciona un folio --</option>
    </select>
    <input type="text" id="codigoProductoInput" placeholder="Código(s) del producto, separados por coma">
    <input type="text" id="cantidadProductoInput" placeholder="Cantidad(es) a devolver, separadas por coma">
    <input type="password" id="adminPass" placeholder="Contraseña de admin">
    <button id="btnFinalizar">Finalizar</button>
    <button id="btnCancelar">Cancelar</button>
  </div>
</div>

<script>
// ============================
// IndexedDB Helper
// ============================
const DB_NAME = 'farmalili-db';
const DB_VERSION = 1;
const STORE_PRODUCTOS = 'productos';
const STORE_VENTAS = 'ventasHistorial';
const STORE_HISTORIAL = 'historial';
const STORE_VENTA_ACTUAL = 'ventaActual'; // Nueva tienda para venta temporal
let db = null;

function openDB() {
  return new Promise((resolve,reject)=>{
    if(db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const idb = e.target.result;
      if(!idb.objectStoreNames.contains(STORE_PRODUCTOS)){
        const prodStore = idb.createObjectStore(STORE_PRODUCTOS,{keyPath:'codigo'});
        prodStore.createIndex('nombre','nombre',{unique:false});
        prodStore.createIndex('categoria','categoria',{unique:false});
      }
      if(!idb.objectStoreNames.contains(STORE_VENTAS)) idb.createObjectStore(STORE_VENTAS,{autoIncrement:true});
      if(!idb.objectStoreNames.contains(STORE_HISTORIAL)) idb.createObjectStore(STORE_HISTORIAL,{autoIncrement:true});
      if(!idb.objectStoreNames.contains(STORE_VENTA_ACTUAL)) idb.createObjectStore(STORE_VENTA_ACTUAL,{keyPath:'id'}); // Crear tienda de venta actual
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

async function idbGet(storeName,key){
  const idb = await openDB();
  return new Promise((resolve,reject)=>{
    const tx=idb.transaction(storeName,'readonly');
    const store=tx.objectStore(storeName);
    const req=store.get(key);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}

async function idbGetAll(storeName){
  const idb=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=idb.transaction(storeName,'readonly');
    const store=tx.objectStore(storeName);
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}

async function idbPut(storeName,value){
  const idb = await openDB();
  return new Promise((resolve,reject)=>{
    const tx=idb.transaction(storeName,'readwrite');
    const store=tx.objectStore(storeName);
    const req=store.put(value);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}

// ============================
// BroadcastChannel para sincronización
// ============================
const ventasChannel = ('BroadcastChannel' in window) ? new BroadcastChannel('farmalili-ventas') : null;
function broadcastUpdate(type,payload={}) {
  const msg={type,payload,ts:Date.now(),source:'ventas'};
  if(ventasChannel) ventasChannel.postMessage(msg);
  try{
    localStorage.setItem('farmalili_sync',JSON.stringify(msg));
    setTimeout(()=>localStorage.removeItem('farmalili_sync'),100);
  }catch(e){console.error(e);}
}

// ============================
// UI y Estado
// ============================
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(!usuarioActivo) window.location.href="index.html";
else document.getElementById("cajero").textContent = "👤 Cajero: "+usuarioActivo;

let venta = [];
let folioCounter = parseInt(localStorage.getItem('folioCounter')||1);

async function cargarVentaActiva(){
  const ventaGuardada = await idbGet(STORE_VENTA_ACTUAL,'ventaTemporalKey'); // Usar la nueva tienda
  venta = ventaGuardada?.items || [];
}

async function guardarVentaActiva(){
  await idbPut(STORE_VENTA_ACTUAL,{id:'ventaTemporalKey',items:venta}); // Usar la nueva tienda
}

const tbody = document.querySelector('#tablaVenta tbody');

// ============================
// Función para obtener el stock total de un producto
// ============================
function getStockTotal(producto) {
  if (producto.lotes) {
    return producto.lotes.reduce((sum, lote) => sum + (lote.stock || 0), 0);
  } else {
    return producto.stock || 0;
  }
}

// ============================
// Función para obtener el lote más antiguo (por caducidad) disponible
// ============================
function getLoteMasAntiguo(producto) {
  if (!producto.lotes || producto.lotes.length === 0) return null;
  // Filtrar lotes con stock > 0
  const lotesDisponibles = producto.lotes.filter(l => (l.stock || 0) > 0);
  if (lotesDisponibles.length === 0) return null;
  // Ordenar por caducidad (más próxima primero)
  lotesDisponibles.sort((a, b) => new Date(a.caducidad) - new Date(b.caducidad));
  return lotesDisponibles[0]; // Devolver el primero (más antiguo)
}

// ============================
// Función render
// ============================
async function renderVenta(){
  tbody.innerHTML='';
  const metodo = document.getElementById("metodoPago").value;
  let total=0;
  let requiereAntibiotico = false;

  for(const v of venta){
    const producto = await idbGet(STORE_PRODUCTOS,v.codigo);
    if(producto?.categoria==='Antibiótico') requiereAntibiotico=true;
  }
  document.getElementById("clienteForm").style.display=requiereAntibiotico?"flex":"none";
  document.getElementById("folioProveedorDiv").style.display= metodo==="Proveedores"?"flex":"none";

  for(let i=0;i<venta.length;i++){
    const v=venta[i];
    const producto = await idbGet(STORE_PRODUCTOS,v.codigo);
    const categoria = producto?.categoria || 'N/A';

    if(metodo==="Proveedores"){
      // Modo Proveedor: Precio editable, no se muestran caducidad ni lote
      const subtotal = (v.precio || 0) * v.cantidad;
      total += subtotal;
      const tr = document.createElement('tr');
      tr.innerHTML=`<td>${v.nombre}</td><td>${v.codigo}</td><td>${categoria}</td>
      <td contenteditable="true" class="venta-cantidad" data-index="${i}">${v.cantidad}</td>
      <td contenteditable="true" class="venta-precio" data-index="${i}">${v.precio || 0}</td>
      <td>${subtotal.toFixed(2)}</td>
      <td colspan="5" style="text-align:center;">--</td>`;
      tbody.appendChild(tr);
    }else{
      // Modo Normal
      const subtotal=v.precio*v.cantidad;
      total+=subtotal;

      let caducidad = '';
      let lote = '';
      let stock = getStockTotal(producto);
      let estatus="OK", clase="status-ok";

      if(categoria==='Antibiótico'){
        // Buscar el lote específico asociado a esta línea de venta
        const loteVenta = producto.lotes ? producto.lotes.find(l => l.lote === v.loteSeleccionado && l.caducidad === v.caducidadSeleccionado) : null;
        if (loteVenta) {
          caducidad = loteVenta.caducidad;
          lote = loteVenta.lote;
          stock = loteVenta.stock; // Stock del lote específico
        } else if (v.loteSeleccionado) { // Si se seleccionó un lote pero no se encuentra (ya vendido?)
          caducidad = v.caducidadSeleccionada;
          lote = v.loteSeleccionado;
          stock = 0; // Marcar como sin stock para ese lote
          estatus = "Sin Stock Lote";
          clase = "status-caducado";
        } else {
          // No se ha seleccionado un lote específico aún, mostrar el más antiguo o mensaje
          const loteAntiguo = getLoteMasAntiguo(producto);
          if (loteAntiguo) {
            caducidad = loteAntiguo.caducidad;
            lote = loteAntiguo.lote;
            stock = loteAntiguo.stock;
          } else {
            caducidad = 'N/A';
            lote = 'N/A';
            estatus = "Sin Lotes";
            clase = "status-caducado";
          }
        }

        // Verificar caducidad
        if(caducidad && caducidad !== 'N/A'){
          const diff=(new Date(caducidad)-new Date())/(1000*60*60*24);
          if(diff<0){ estatus="Caducado"; clase="status-caducado"; }
          else if(diff<=30){ estatus="Próximo"; clase="status-proximo"; }
        } else if (estatus !== "Sin Lotes" && estatus !== "Sin Stock Lote") {
          estatus="Sin Fecha";
        }
      } else {
         // Para no antibióticos, usar stock total
         stock = getStockTotal(producto);
         estatus = ""; // Sin estatus específico para no antibióticos
      }

      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${v.nombre}</td><td>${v.codigo}</td><td>${categoria}</td>
      <td contenteditable="true" class="venta-cantidad" data-index="${i}">${v.cantidad}</td>
      <td style="background:#0fcf2c;color:white;">${v.precio.toFixed(2)}</td>
      <td>${subtotal.toFixed(2)}</td>
      <td>${categoria==='Antibiótico'?caducidad:''}</td>
      <td>${categoria==='Antibiótico'?lote:''}</td>
      <td class="${clase}">${estatus} Stock: ${stock}</td>
      <td><button class="btnEliminar" data-index="${i}">🗑</button></td>`;
      tbody.appendChild(tr);
    }
  }

  // Añadir eventos para editar cantidad y precio directamente en la tabla (modo proveedor)
  document.querySelectorAll('.venta-cantidad').forEach(input => {
    input.addEventListener('blur', async (e) => {
      const index = parseInt(e.target.dataset.index);
      const nuevaCantidad = parseFloat(e.target.textContent) || 1;
      if (nuevaCantidad > 0) {
          venta[index].cantidad = nuevaCantidad;
          await renderVenta(); // Recalcular total y guardar
          actualizarCambio();
      } else {
          e.target.textContent = venta[index].cantidad; // Revertir si es inválido
      }
    });
    // Opcional: manejar Enter para confirmar edición
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.target.blur();
      }
    });
  });

  document.querySelectorAll('.venta-precio').forEach(input => {
    input.addEventListener('blur', async (e) => {
      const index = parseInt(e.target.dataset.index);
      const nuevoPrecio = parseFloat(e.target.textContent) || 0;
      if (nuevoPrecio >= 0) { // Permitir precio 0 para proveedores
          venta[index].precio = nuevoPrecio;
          await renderVenta(); // Recalcular total y guardar
          actualizarCambio();
      } else {
          e.target.textContent = venta[index].precio; // Revertir si es inválido
      }
    });
    // Opcional: manejar Enter para confirmar edición
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.target.blur();
      }
    });
  });

  document.querySelectorAll('.btnEliminar').forEach(btn=>{
    btn.onclick=async ()=>{
      venta.splice(parseInt(btn.dataset.index),1);
      await renderVenta();
      actualizarCambio();
      await guardarVentaActiva();
    };
  });

  if(metodo!=="Proveedores"){
    document.getElementById('totalVenta').textContent="Total: $"+total.toFixed(2);
  }else{
    // En modo proveedor, el total se calcula igualmente
    document.getElementById('totalVenta').textContent="Total: $"+total.toFixed(2);
  }

  await guardarVentaActiva();
}

// ============================
// Buscar Producto
// ============================
document.getElementById('searchProducto').addEventListener('keydown', async e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const metodo=document.getElementById("metodoPago").value;
    const busqueda=e.target.value.trim().toLowerCase();
    if(!busqueda) return;

    if(metodo==="Proveedores"){
      const nombre = prompt("Nombre del producto del proveedor:");
      if(!nombre) return alert("❌ Nombre requerido");
      // Añadir producto con precio editable y cantidad editable
      venta.push({nombre:nombre,codigo:busqueda,cantidad:1,precio:0});
    }else{
      let prod = await idbGet(STORE_PRODUCTOS,busqueda);
      if(!prod){
        const productos = await idbGetAll(STORE_PRODUCTOS);
        prod = productos.find(p=>p.nombre.toLowerCase()===busqueda);
        if(!prod) return alert("Producto no encontrado");
      }

      if(prod.categoria === 'Antibiótico'){
          if(!prod.lotes || prod.lotes.length === 0) {
              alert("El antibiótico no tiene lotes registrados.");
              e.target.value=''; return;
          }

          // Crear un contenedor temporal para el selector de lotes y cantidad
          const divSelector = document.createElement('div');
          divSelector.style.position = 'fixed';
          divSelector.style.top = '50%';
          divSelector.style.left = '50%';
          divSelector.style.transform = 'translate(-50%, -50%)';
          divSelector.style.background = 'white';
          divSelector.style.padding = '15px';
          divSelector.style.border = '1px solid #ccc';
          divSelector.style.borderRadius = '8px';
          divSelector.style.zIndex = '3000';
          divSelector.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';

          const labelCantidad = document.createElement('label');
          labelCantidad.textContent = 'Cantidad: ';
          const inputCantidad = document.createElement('input');
          inputCantidad.type = 'number';
          inputCantidad.min = '1';
          inputCantidad.value = '1';
          inputCantidad.className = 'cantidad-input';

          const labelLote = document.createElement('label');
          labelLote.textContent = 'Lote: ';
          const selectLote = document.createElement('select');
          selectLote.className = 'lote-selector';

          prod.lotes.forEach(lote => {
              if((lote.stock || 0) > 0) { // Solo mostrar lotes con stock
                  const option = document.createElement('option');
                  option.value = `${lote.lote}|${lote.caducidad}`;
                  option.textContent = `${lote.lote} (${lote.caducidad}) - Stock: ${lote.stock}`;
                  selectLote.appendChild(option);
              }
          });

          if(selectLote.children.length === 0) {
              alert("No hay lotes disponibles para este antibiótico.");
              e.target.value=''; return;
          }

          const btnAceptar = document.createElement('button');
          btnAceptar.textContent = 'Agregar';
          btnAceptar.onclick = async () => {
              const seleccion = selectLote.value.split('|');
              const loteSeleccionado = seleccion[0];
              const caducidadSeleccionada = seleccion[1];
              const cantidad = parseInt(inputCantidad.value) || 1;

              // Validar stock para el lote seleccionado
              const loteObj = prod.lotes.find(l => l.lote === loteSeleccionado && l.caducidad === caducidadSeleccionada);
              if (!loteObj || cantidad > (loteObj.stock || 0)) {
                  alert(`Stock insuficiente para el lote ${loteSeleccionado}. Stock disponible: ${loteObj ? loteObj.stock : 0}`);
                  document.body.removeChild(divSelector);
                  return;
              }

              // Añadir a la venta
              const existe = venta.find(v => v.codigo === prod.codigo && v.loteSeleccionado === loteSeleccionado && v.caducidadSeleccionada === caducidadSeleccionada);
              if(existe){
                  // Si ya existe con el mismo lote/caducidad, sumar cantidad
                  if(existe.cantidad + cantidad > loteObj.stock) {
                      alert(`Stock insuficiente para el lote ${loteSeleccionado}. Stock disponible: ${loteObj.stock}, ya seleccionado: ${existe.cantidad}`);
                      document.body.removeChild(divSelector);
                      return;
                  }
                  existe.cantidad += cantidad;
              } else {
                  // Si no existe, añadir nuevo ítem con lote/caducidad específicos
                  venta.push({
                      nombre: prod.nombre,
                      codigo: prod.codigo,
                      precio: prod.precio,
                      cantidad: cantidad,
                      loteSeleccionado: loteSeleccionado, // Guardar el lote específico
                      caducidadSeleccionada: caducidadSeleccionada // Guardar la caducidad específica
                  });
              }

              document.body.removeChild(divSelector);
              e.target.value=''; await renderVenta(); actualizarCambio();
          };

          const btnCancelar = document.createElement('button');
          btnCancelar.textContent = 'Cancelar';
          btnCancelar.onclick = () => {
              document.body.removeChild(divSelector);
              e.target.value=''; // Limpiar búsqueda
          };

          divSelector.appendChild(labelCantidad);
          divSelector.appendChild(inputCantidad);
          divSelector.appendChild(document.createElement('br'));
          divSelector.appendChild(labelLote);
          divSelector.appendChild(selectLote);
          divSelector.appendChild(document.createElement('br'));
          divSelector.appendChild(btnAceptar);
          divSelector.appendChild(btnCancelar);
          document.body.appendChild(divSelector);
          inputCantidad.focus(); // Enfocar el input de cantidad

          return; // Salir para no limpiar el input aquí
      } else {
          // Lógica para productos no antibióticos (stock simple)
          const stockTotal = getStockTotal(prod);
          if(stockTotal <= 0) return alert("Producto sin stock");

          const existe=venta.find(v=>v.codigo===prod.codigo);
          if(existe){
              if(existe.cantidad+1>stockTotal) return alert("No hay suficiente stock total");
              existe.cantidad++;
          } else{
              venta.push({nombre:prod.nombre,codigo:prod.codigo,precio:prod.precio,cantidad:1});
          }
      }
    }
    e.target.value=''; await renderVenta(); actualizarCambio();
  }
});

function actualizarCambio(){
  const metodo = document.getElementById("metodoPago").value;
  if(metodo==="Proveedores") return;
  const total=venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
  const pago=parseFloat(document.getElementById('pagoInput').value)||0;
  document.getElementById('cambioDisplay').value=pago>=total?(pago-total).toFixed(2):"0.00";
}
document.getElementById('pagoInput').addEventListener('input', actualizarCambio);

// ============================
// Imprimir Ticket (MODIFICADO para incluir Folio Proveedor y formato térmico)
// ============================
function imprimirTicket(ventaData, infoCliente=null){
  // 1. Ajuste el tamaño de la ventana para simular una impresora térmica (ej. 58mm)
  const ventana=window.open("","Ticket","width=280,height=600"); 
  const fecha=new Date(ventaData.fecha);
  let html=`<html><head><title>Ticket</title>
 <style>
  /* 2. Ajuste de CSS para formato de ticket térmico */
  body {font-family:'Courier New',monospace;margin:0;padding:5px;background:#fff;color:#000;font-size:9px;line-height:1.1;width:2.2in;margin:0 auto;}
  .ticket-header{text-align:center;padding:5px 0;border-bottom:1px solid #000;margin-bottom:5px;}
  .ticket-header h2{margin:3px 0;font-size:12px;}
  .info-container{display:flex;justify-content:space-between;margin:5px 0;font-size:9px;}
  table{width:100%;border-collapse:collapse;margin:5px 0;font-size:9px;}
  th,td{padding:2px;text-align:left;border-bottom:1px solid #ddd;}
  .total-row{font-weight:bold;background:#f0f0f0;padding:4px 0;}
  .footer{text-align:center;margin-top:10px;padding-top:5px;border-top:1px dashed #000;font-style:italic;font-size:8px;}
  </style>
  </head><body>
  <div class="ticket-header">
    <h2>💊FarmaciaLili 2.0 💊</h2>
    <p>Farmacia Copias, Manzana 012</p>
    <p>56589 Zoquiapan, Méx</p>
    <p>Tel: 55 7883 6807</p>
  </div>
  <div><strong>Folio:</strong> ${ventaData.folio} &nbsp; <strong>Fecha:</strong> ${fecha.toLocaleDateString()} &nbsp; <strong>Hora:</strong> ${fecha.toLocaleTimeString()}</div>
  <div><strong>Cajero:</strong> ${ventaData.cajero}</div>
  <div><strong>Método:</strong> ${ventaData.metodo}</div>`;

  if(infoCliente && (infoCliente.nombre||infoCliente.cedula||infoCliente.folioReceta)){
  
    if(infoCliente.nombre) html+=`Nombre: ${infoCliente.nombre}<br>`;
    if(infoCliente.cedula) html+=`Cédula: ${infoCliente.cedula}<br>`;
    if(infoCliente.direccion) html+=`Dirección: ${infoCliente.direccion}<br>`;
    if(infoCliente.folioReceta) html+=`Folio Receta: ${infoCliente.folioReceta}<br>`;
    html+=`</div>`;
  }
  
  // *** Modificación: Agregar Folio Proveedor ***
  if(ventaData.metodo==="Proveedores" && ventaData.folioProveedor){
    html+=`<div><strong>Folio Proveedor:</strong> ${ventaData.folioProveedor}</div>`;
  }
  // *** Fin Modificación ***

  if(ventaData.metodo==="Proveedores"){
    // *** Modificación: Tabla para Proveedores con Codigo completo ***
    html+=`<table><tr><th>Producto</th><th>Código</th><th>Cant.</th><th>Precio</th></tr>`;
    ventaData.productos.forEach(p=>html+=`<tr><td>${p.nombre}</td><td>${p.codigo}</td><td style="text-align:right;">${p.cantidad}</td><td style="text-align:right;">$${(p.precio||0).toFixed(2)}</td></tr>`);
    html+=`</table><div class="total-row">Total: $${ventaData.total.toFixed(2)}</div>`;
  }else{
    // Tabla para otros métodos de pago
    html+=`<table><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr>`;
    ventaData.productos.forEach(p=>html+=`<tr><td>${p.nombre}</td><td style="text-align:right;">${p.cantidad}</td><td style="text-align:right;">$${p.precio.toFixed(2)}</td><td style="text-align:right;">$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`);
    html+=`</table><div class="total-row">Total: $${ventaData.total.toFixed(2)}</div>`;
    if(ventaData.pago) html+=`<div>Pago: $${ventaData.pago.toFixed(2)}</div><div>Cambio: $${ventaData.cambio.toFixed(2)}</div>`;
  }

  html+=`<div class="footer">¡Gracias por su compra!<br>FarmaciaLili 1.1</div></body></html>`;
  ventana.document.write(html);
  ventana.document.close();
  ventana.focus();
  ventana.print();
  ventana.close();
}

// ============================
// Cobrar (CÓDIGO MODIFICADO)
// ============================
document.getElementById('btnCobrar').addEventListener('click', async ()=>{
  if(!venta.length) return alert("No hay productos para cobrar");
  const metodo=document.getElementById("metodoPago").value;
  let infoCliente=null;

  if(metodo!=="Proveedores"){
    const total=venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
    const pago=parseFloat(document.getElementById("pagoInput").value)||0;
    if(pago<total) return alert("Pago insuficiente");

    // --- Capturar datos del cliente ---
    infoCliente={
      nombre:document.getElementById("clienteNombre").value,
      cedula:document.getElementById("clienteCedula").value,
      direccion:document.getElementById("clienteDireccion").value,
      folioReceta:document.getElementById("folioReceta").value
    };
    // --- Fin Capturar datos del cliente ---

    // --- Actualizar stock LOCALMENTE (en la página de ventas) ---
    for(const v of venta) {
      const prod = await idbGet(STORE_PRODUCTOS, v.codigo);
      if(prod) {
        if(prod.categoria === 'Antibiótico' && prod.lotes) {
          const loteIdx = prod.lotes.findIndex(l => l.lote === v.loteSeleccionado && l.caducidad === v.caducidadSeleccionada);
          if(loteIdx !== -1) {
            prod.lotes[loteIdx].stock = Math.max(0, (prod.lotes[loteIdx].stock || 0) - v.cantidad);
          }
        } else {
          prod.stock = Math.max(0, (prod.stock || 0) - v.cantidad);
        }
        await idbPut(STORE_PRODUCTOS, prod);
      }
    }
    // --- Fin Actualizar stock ---

    // --- Crear objeto de venta con datos del cliente ---
    const ventaData={
        folio:folioCounter,
        fecha:new Date(),
        cajero:usuarioActivo,
        productos:venta,
        cliente: infoCliente, // <-- Añadido
        total,
        pago,
        cambio:pago-total,
        metodo
    };
    // --- Fin Crear objeto de venta ---

    // --- Crear objeto de historial con datos del cliente ---
    const historialData = {
        accion: 'venta',
        venta: ventaData, // <-- Incluye cliente dentro de venta
        usuario: usuarioActivo,
        fecha: new Date().toISOString()
    };
    // --- Fin Crear objeto de historial ---

    await idbPut(STORE_VENTAS,ventaData);
    await idbPut(STORE_HISTORIAL, historialData); // <-- Guardar historialData en lugar de objeto inline

    // >>> INICIO: SINCRONIZACIÓN CON INVENTARIO <<<
    const productosVendidosPayload = venta.map(item => ({
        codigo: item.codigo,
        cantidad: item.cantidad
    }));
    broadcastUpdate('venta', {
        productos: productosVendidosPayload,
        usuario: usuarioActivo
    });
    // >>> FIN: SINCRONIZACIÓN CON INVENTARIO <<<

    imprimirTicket(ventaData,infoCliente);
    venta=[]; await renderVenta();
    document.getElementById("pagoInput").value='';
    actualizarCambio();
  } else {
    // --- Modo Proveedor (no afecta el inventario) ---
    const total = venta.reduce((acc, v) => acc + (v.precio || 0) * v.cantidad, 0);
    const folioProveedor = document.getElementById("folioProveedor").value.trim();
    if (!folioProveedor) {
        alert("Ingrese folio del proveedor");
        return;
    }
    // En modo proveedor, no se capturan datos de cliente, cliente es null
    const ventaData={folio:folioCounter,fecha:new Date(),cajero:usuarioActivo,productos:venta,total,metodo,folioProveedor, cliente: null}; // <-- Añadido cliente: null
    await idbPut(STORE_VENTAS,ventaData);
    await idbPut(STORE_HISTORIAL, { accion: 'venta_proveedor', venta: ventaData, usuario: usuarioActivo, fecha: new Date().toISOString() });
    imprimirTicket(ventaData);
    venta=[]; await renderVenta();
    document.getElementById("folioProveedor").value='';
  }
  folioCounter++; localStorage.setItem('folioCounter',folioCounter);
});

// ============================
// Panel Reembolso
// ============================
document.getElementById('btnReembolso').addEventListener('click', async ()=>{
  document.getElementById('panelReembolso').style.display = 'flex';
  const selectFolio = document.getElementById('folioVentaSelect');
  selectFolio.innerHTML = '<option value="">-- Selecciona un folio --</option>'; // Limpiar opciones
  try {
    const ventas = await idbGetAll(STORE_VENTAS);
    // Ordenar por fecha más reciente primero
    ventas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    ventas.forEach(v => {
        const option = document.createElement('option');
        option.value = v.folio;
        option.textContent = `Folio ${v.folio} - ${v.fecha ? new Date(v.fecha).toLocaleDateString() : 'N/A'}`;
        selectFolio.appendChild(option);
    });
  } catch (e) {
      console.error("Error cargando folios de ventas:", e);
      alert("Error al cargar folios de ventas.");
  }
});

document.getElementById('btnCancelar').addEventListener('click', ()=>{
  document.getElementById('panelReembolso').style.display = 'none';
  document.getElementById('folioVentaSelect').value = '';
  document.getElementById('codigoProductoInput').value = '';
  document.getElementById('cantidadProductoInput').value = '';
  document.getElementById('adminPass').value = '';
});

document.getElementById('btnFinalizar').addEventListener('click', async ()=>{
  const folioVenta = document.getElementById('folioVentaSelect').value;
  const codigos = document.getElementById('codigoProductoInput').value.split(',').map(c => c.trim()).filter(c => c);
  const cantidades = document.getElementById('cantidadProductoInput').value.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c) && c > 0);
  const pass = document.getElementById('adminPass').value;

  if (!folioVenta || codigos.length === 0 || cantidades.length === 0 || !pass) {
      alert("Por favor, complete todos los campos del reembolso.");
      return;
  }

  if (pass !== 'Mariposa2026') {
      alert("Contraseña de admin incorrecta.");
      return;
  }

  if (codigos.length !== cantidades.length) {
      alert("El número de códigos y cantidades debe coincidir.");
      return;
  }

  try {
    const ventas = await idbGetAll(STORE_VENTAS);
    const ventaAEliminar = ventas.find(v => v.folio.toString() === folioVenta);

    if (!ventaAEliminar) {
        alert("Venta no encontrada.");
        return;
    }

    // Actualizar stock para cada producto devuelto
    for (let i = 0; i < codigos.length; i++) {
        const codigo = codigos[i];
        const cantidad = cantidades[i];
        const producto = await idbGet(STORE_PRODUCTOS, codigo);

        if (producto) {
            if (producto.categoria === 'Antibiótico' && producto.lotes) {
                // Para antibióticos, buscar el lote vendido en la venta original
                // y devolver la cantidad a ese lote específico.
                const itemVenta = ventaAEliminar.productos.find(p => p.codigo === codigo);
                if (itemVenta && itemVenta.loteSeleccionado && itemVenta.caducidadSeleccionada) {
                    const loteIdx = producto.lotes.findIndex(l => l.lote === itemVenta.loteSeleccionado && l.caducidad === itemVenta.caducidadSeleccionada);
                    if (loteIdx !== -1) {
                        producto.lotes[loteIdx].stock = (producto.lotes[loteIdx].stock || 0) + cantidad;
                    }
                } else {
                    console.warn(`No se encontró el lote específico para el producto ${codigo} en la venta ${folioVenta}. No se actualizó el stock del lote.`);
                }
            } else {
                // Para otros productos, sumar a stock total
                producto.stock = (producto.stock || 0) + cantidad;
            }
            await idbPut(STORE_PRODUCTOS, producto);
        }
    }

    // Registrar el reembolso en el historial
    await idbPut(STORE_HISTORIAL, {
        accion: 'reembolso',
        folioVenta: folioVenta,
        codigos: codigos,
        cantidades: cantidades,
        usuario: usuarioActivo,
        fecha: new Date().toISOString()
    });

    // Enviar mensaje de reembolso para sincronizar inventario
    broadcastUpdate('reembolso', { codigos: codigos, cantidades: cantidades });

    alert("Reembolso procesado correctamente.");
    document.getElementById('panelReembolso').style.display = 'none';
    document.getElementById('folioVentaSelect').value = '';
    document.getElementById('codigoProductoInput').value = '';
    document.getElementById('cantidadProductoInput').value = '';
    document.getElementById('adminPass').value = '';

  } catch (e) {
      console.error("Error al procesar reembolso:", e);
      alert("Error al procesar el reembolso.");
  }
});

// ============================
// Deshabilitar navegación con flechas
// ============================
window.addEventListener('popstate', (e) => {
  history.pushState(null, null, location.href);
});

// Al cargar la página, agregar un estado inicial
history.pushState(null, null, location.href);

// ============================
// Inicialización
// ============================
(async()=>{
    await openDB(); // Asegurar que la DB esté abierta
    await cargarVentaActiva();
    await renderVenta();
})();

</script>
</body>
</html>
