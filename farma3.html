<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>💳 Ventas - FarmaciaLili 1.0 💳</title>
<style>
body {background:#f4f4f4;color:#000;font-family:system-ui,sans-serif;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;font-size:1.15rem;overflow:hidden;}
header {background:#fff;color:#000;padding:34px;font-size:26px;font-weight:bold;text-align:center;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
header img{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:250px;height:100px;border-radius:25px;border:0px solid #e5e7eb;}
.main-menu {display:flex;align-items:center;padding:10px;background-color:#68af6b;color:white;}
.menu-link {color:white;text-decoration:none;margin-right:15px;}
.main-menu .menu-link {color:#1f2937;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:500;transition:0.2s;border:1px solid #e5e7eb;}
.main-menu .menu-link:hover {background:#fff;color:#111827;}
.main-menu .menu-link.active {background:#2563eb;color:white;border-color:#2563eb;}
#cajero {margin-left:auto;font-weight:bold;color:#000;}
#logout {background:#dc2626;color:#fff;border:none;border-radius:8px;padding:8px 12px;margin-left:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
#logout:hover {background:#b91c1c;}
main {flex:1;display:flex;flex-direction:column;padding:10px;overflow:hidden;}
#ventaCard {background:#fff;border-radius:16px;padding:10px;box-shadow:0 4px 10px rgba(255,253,253,0.1);flex:1;display:flex;flex-direction:column;height:100%;}
#searchProducto {margin-bottom:5px;padding:10px;font-size:1rem;border-radius:8px;border:1px solid #fff;}
.tabla-contenedor {flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #ffffff; border-radius: 5px; background:  linear-gradient(rgb(243, 239, 239), rgba(255, 255, 255, 0.4)), 
   url('lododoc .png') no-repeat center center; background-size: auto;  background-position: center;  background-attachment: fixed; max-height: 55vh; box-shadow: inset 0 0 8px rgba(0,0,0,0.2);}
table { width: 100%; border-collapse: collapse; font-size: 1rem; table-layout: fixed;}
th, td { padding:2px; border-bottom: 1px solid #e5e7eb; text-align: left; word-wrap: break-word;}
th { position: sticky; top: 0; background: #68af6b; color: white; z-index: 10;}
.status-ok {background:#8cee73;}
.status-proximo {background:#f5f246;}
.status-caducado {background:#ff0000;}
input,select,button {padding:8px;border-radius:6px;border:1px solid #2563eb;margin:4px 0;}
input[readonly]{background:#ffffff;color:#000;}
button {cursor:pointer;font-weight:bold;transition:0.2s;}
#btnCobrar {margin-top:6px;background-color:rgb(64,255,0);}
#btnReembolso {margin-top:6px;background-color:red;color:white;}
#clienteForm,#folioProveedorDiv {display:none;flex-wrap:wrap;gap:4px;margin-top:5px;}
#clienteForm input,#folioProveedorDiv input {flex:1;}
#panelReembolso {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:2000;}
#panelReembolso .contenido {background:#000;padding:1px;border-radius:16px;width:420px;display:flex;flex-direction:column;gap:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease-in-out;}
#panelReembolso h3 {margin:0;color:#2563eb;text-align:center;}
#panelReembolso button {padding:1px;border-radius:8px;font-weight:bold;cursor:pointer;}
#btnFinalizar {background:red;color:white;} #btnCancelar {background:yellow;color:black;}
#modalLote {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:2000;}
#modalLote .contenido {background:#fff;padding:20px;border-radius:16px;width:360px;display:flex;flex-direction:column;gap:10px;}
#modalLote button {padding:6px;font-weight:bold;cursor:pointer;border-radius:8px;}
@keyframes fadeIn {from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>
<header>
<img src="lododoc .png" alt="Logo Ventas">
💳 Ventas - FarmaciaLili 3.0 💳
</header>

<nav class="main-menu">
 <a href="farma3.html" class="menu-link active">💳 Ventas</a>
 <a href="inve3.html" class="menu-link">📦 Inventario</a>
 <a href="histori3.html" class="menu-link">📜 Historial</a>
 <span id="cajero"></span>
 <button id="logout">Cerrar Sesión</button>
</nav>

<main>
<div id="ventaCard">
  <input type="text" id="searchProducto" placeholder="Escanea o escribe código/nombre">
  <div class="tabla-contenedor">
    <table id="tablaVenta">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Código</th>
          <th>Categoría</th>
          <th>Cant.</th>
          <th>Precio</th>
          <th>Subtotal</th>
          <th>Lote</th>
          <th>Caducidad</th>
          <th>Status / Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <p id="totalVenta">Total: $0.00</p>

  <div id="clienteForm">
    <input type="text" id="clienteNombre" placeholder="Nombre del Doctor">
    <input type="text" id="clienteCedula" placeholder="Cédula profesional" maxlength="8">
    <input type="text" id="clienteDireccion" placeholder="Dirección">
    <input type="text" id="folioReceta" placeholder="Folio de receta" maxlength="8">
  </div>

  <div id="folioProveedorDiv">
    <input type="text" id="folioProveedor" placeholder="Folio del proveedor">
    
  </div>

  <div id="pagoForm">
    <input type="number" id="pagoInput" placeholder="Pago recibido" min="0">
    <input type="text" id="cambioDisplay" placeholder="Cambio" readonly>
    <select id="metodoPago">
      <option value="Efectivo">Efectivo</option>
      <option value="Tarjeta">Tarjeta</option>
      <option value="Transferencia">Transferencia</option>
      <option value="Proveedores">Proveedores</option>
    </select>
  </div>

  <button id="btnCobrar">Cobrar</button>
  <button id="btnReembolso">Reembolso</button>
</div>
</main>

<div id="panelReembolso">
  <div class="contenido">
    <h3>Reembolso</h3>
    <input type="text" id="folioVentaInput" placeholder="Folio de la venta">
    <input type="text" id="codigoProductoInput" placeholder="Código(s) del producto, separados por coma">
    <input type="password" id="adminPass" placeholder="Contraseña de admin">
    <button id="btnFinalizar">Finalizar</button>
    <button id="btnCancelar">Cancelar</button>
  </div>
</div>

<script>
// Usuario activo
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(!usuarioActivo){ window.location.href="index.html"; }
else { document.getElementById("cajero").textContent = "👤 Cajero: "+usuarioActivo; }

// Inventario y venta
let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
let venta = JSON.parse(localStorage.getItem('ventaActiva')) || [];
let folioCounter = parseInt(localStorage.getItem('folioCounter')||1);

function parseJSON(key){ 
  try{ 
    return JSON.parse(localStorage.getItem(key)||"[]"); 
  }catch(e){ 
    console.warn(`Error al parsear ${key}:`, e);
    return []; 
  } 
}

function setJSON(key,val){ 
  localStorage.setItem(key, JSON.stringify(val)); 
}


function guardarVentaActiva(){ localStorage.setItem('ventaActiva', JSON.stringify(venta)); }
function guardarInventario(){ localStorage.setItem('inventario', JSON.stringify(inventario)); }
function guardarHistorial(ventaData){ 
  // MODIFICADO: Usar la clave 'ventas' como el historial de transacciones NO cortadas
  const historial = parseJSON('ventas');
  historial.push(ventaData);
  setJSON('ventas', historial);
}

// 💡 FUNCIÓN DE AYUDA: Obtener lotes disponibles de un producto
function getLotesDisponibles(codigo) {
    const prod = inventario.find(p => p.codigo === codigo);
    if (!prod || !prod.lotes || prod.lotes.length === 0) return [];

    // Retorna solo lotes con stock > 0, ordenados por caducidad
    return prod.lotes
        .filter(l => l.stock > 0)
        .sort((a, b) => new Date(a.caducidad) - new Date(b.caducidad));
}

// Render venta
function renderVenta(){
  const tbody = document.querySelector('#tablaVenta tbody');
  tbody.innerHTML='';
  const metodo = document.getElementById("metodoPago").value;
  let total=0;
  let requiereAntibiotico = venta.some(v=>v.categoria && v.categoria.toLowerCase().includes("antibiótico"));
  document.getElementById("clienteForm").style.display=requiereAntibiotico?"flex":"none";
  document.getElementById("folioProveedorDiv").style.display= metodo==="Proveedores"?"flex":"none";

  venta.forEach((v,index)=>{
    let subtotal=v.precio*v.cantidad;
    total+=subtotal;
    
    // Calcula estatus solo si hay caducidad
    let estatus="OK", clase="status-ok";
    if(v.caducidad){
      const diff=(new Date(v.caducidad)-new Date())/(1000*60*60*24);
      if(diff<0){ estatus="Caducado"; clase="status-caducado"; }
      else if(diff<=30){ estatus="Próximo"; clase="status-proximo"; }
    }
    
    const tr=document.createElement('tr');

    // 💡 SINCRONIZACIÓN 2: Lógica de selección de Lote/Stock
    let loteHtml='';
    let currentStock = v.stock ?? 'N/A'; // Stock para mostrar
    let maxCantidad = v.stock ?? 999;     // Máximo para el input
    
    if(v.categoria && v.categoria.toLowerCase().includes("antibiótico")){
      const lotesDisponibles = getLotesDisponibles(v.codigo);
      
      // Si no ha seleccionado un lote, el stock es 0, forzando la selección
      if(!v.lote){
        currentStock = 0;
        maxCantidad = 0;
      } else {
        // Si ya tiene un lote seleccionado, actualiza el stock real del lote
        const loteActual = lotesDisponibles.find(l => l.lote === v.lote);
        if (loteActual) {
            currentStock = loteActual.stock;
            maxCantidad = loteActual.stock;
        } else {
            // El lote seleccionado ya no tiene stock, se resetea
            v.lote = '';
            v.caducidad = '';
            currentStock = 0;
            maxCantidad = 0;
        }
      }

      loteHtml=`<select data-index="${index}" class="loteSelect">
        <option value="">${v.lote ? `Lote: ${v.lote}` : 'lotes'}</option>
        ${lotesDisponibles.map(l=>`<option value="${l.lote}" data-cad="${l.caducidad}" data-stock="${l.stock}" :''}>${l.lote} (Stock:${l.stock} - Cad:${l.caducidad})</option>`).join('')}
      </select>`;
      
      // Asegura que la cantidad no exceda el stock del lote
      if(v.cantidad > maxCantidad) v.cantidad = maxCantidad > 0 ? 1 : 0;
    } 
    // Para productos NO loteados, el stock es el global (v.stock viene directamente del inventario)
    else {
      // Stock para productos simples (no loteados)
      const prod = inventario.find(p => p.codigo === v.codigo);
      if(prod) {
          currentStock = prod.stock;
          maxCantidad = prod.stock;
      }
      if(v.cantidad > maxCantidad) v.cantidad = maxCantidad > 0 ? 1 : 0;
      loteHtml=v.lote||'—';
    }


    tr.innerHTML=` 
      <td>${v.nombre}</td>
      <td>${v.codigo}</td>
      <td>${v.categoria||''}</td>
      <td><input type="number" min="1" max="${maxCantidad}" value="${v.cantidad}" data-index="${index}" class="cantidadInput" ${maxCantidad === 0 ? 'readonly' : ''}></td>
      <td class="precio-verde">$${v.precio.toFixed(2)}</td>
      <td>${subtotal.toFixed(2)}</td>
      <td>${loteHtml}</td>
      <td>${v.caducidad||'—'}</td>
      <td class="${clase}">${estatus} - Stock:${currentStock}</td>
      <td><button class="btnEliminar" data-index="${index}">🗑</button></td>`;
    tbody.appendChild(tr);
    
    // Actualiza el objeto venta con el stock máximo real para el cálculo del total
    v.maxStock = maxCantidad;
  });

  // Listeners cantidad
  document.querySelectorAll('.cantidadInput').forEach(input=>{
    input.addEventListener('input', e=>{
      const idx=parseInt(e.target.dataset.index);
      let valor=parseInt(e.target.value);
      const maxStock = venta[idx].maxStock;

      if(isNaN(valor) || valor<1) valor=1;
      if(valor > maxStock) valor = maxStock;
      
      e.target.value = valor;
      venta[idx].cantidad = valor;
      renderVenta();
      actualizarCambio();
    });
  });

  // Listeners eliminar
  document.querySelectorAll('.btnEliminar').forEach(btn=>{
    btn.onclick=()=>{ venta.splice(parseInt(btn.dataset.index),1); renderVenta(); actualizarCambio(); };
  });

  // 💡 SINCRONIZACIÓN 3: Listener para seleccionar lote
  document.querySelectorAll('.loteSelect').forEach(select=>{
    select.addEventListener('change', e=>{
      const idx=parseInt(e.target.dataset.index);
      const opcion=e.target.selectedOptions[0];
      
      if(opcion.value === ""){
        // Si deselecciona el lote
        venta[idx].lote = '';
        venta[idx].caducidad = '';
        venta[idx].stock = 0;
        venta[idx].cantidad = 0;
      } else {
        // Selecciona un lote
        venta[idx].lote=opcion.value;
        venta[idx].caducidad=opcion.dataset.cad || '';
        venta[idx].stock=parseInt(opcion.dataset.stock) || 0; // Stock del lote
        
        // La cantidad inicial es 1, o el stock del lote si es menor.
        venta[idx].cantidad = Math.min(1, venta[idx].stock);
      }
      
      renderVenta();
      actualizarCambio();
    });
  });

  // Total
  if(metodo!=="Proveedores"){
    document.getElementById('totalVenta').textContent="Total: $"+total.toFixed(2);
  } else {
    // Si es proveedor, la cantidad total se calcula de los subtotales
    document.getElementById('totalVenta').textContent="Monto total: $"+total.toFixed(2);
  }

  guardarVentaActiva();
}

// 💡 SINCRONIZACIÓN 4: Búsqueda y Adición de producto
document.getElementById('searchProducto').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const busqueda = e.target.value.trim();
    if(!busqueda) return;
    const metodo = document.getElementById("metodoPago").value;

    if(metodo === "Proveedores"){
      const nombreProv = prompt("Nombre del proveedor:");
      if(!nombreProv) return alert("Debe ingresar el nombre del proveedor.");
      const precio = parseFloat(prompt("Monto a pagar"));
      const cantidad = parseFloat(prompt("La cantidad proveedor es 1)"));
      if(isNaN(precio) || isNaN(cantidad) || cantidad<=0) return alert("Datos inválidos.");
      venta.push({nombre:nombreProv,codigo:busqueda,precio,cantidad:"1",lote:"",caducidad:"",stock:99,categoria:"Proveedor",maxStock:999});
      e.target.value='';
      renderVenta();
      actualizarCambio();
      return;
    }

    const prod = inventario.find(p=>p.codigo.toLowerCase()===busqueda.toLowerCase() || p.nombre.toLowerCase()===busqueda.toLowerCase());
    if(!prod) return alert("Producto no encontrado");
    
    // Calcula stock total para la verificación inicial
    const stockTotal = prod.lotes?.reduce((a,b)=>a+b.stock,0) || prod.stock || 0;
    if(stockTotal<=0) return alert("Producto sin stock");
    
    // Crear objeto de venta con valores iniciales
    const productoParaVenta = {
        nombre: prod.nombre,
        codigo: prod.codigo,
        precio: prod.precio,
        stock: prod.stock, // Stock global (solo para productos no loteados)
        stockMin: prod.stockMin,
        entradas: prod.entradas,
        categoria: prod.categoria,
        lotes: prod.lotes, // Se incluye la lista de lotes (para renderVenta)
        
        // Propiedades de la VENTA (se inicializan vacías/cero)
        cantidad: 1, // Se ajustará a 1 o 0 si es loteado y no seleccionado
        lote: '',
        caducidad: '',
        maxStock: stockTotal // Máximo stock inicial para referencia
    };
    
    // Si es antibiótico, se anula el stock, lote y caducidad para forzar la selección.
    if(productoParaVenta.categoria && productoParaVenta.categoria.toLowerCase().includes("antibiótico")){
        productoParaVenta.stock = 0; // El stock real es el del lote seleccionado
        productoParaVenta.cantidad = 0; // La cantidad inicial es 0 hasta que se escoja un lote
    }
    
    // Si ya existe en la venta, no se añade de nuevo, se debe usar la selección de lote
    if(venta.find(v => v.codigo === productoParaVenta.codigo)){
        alert("Producto ya añadido. Por favor, ajuste la cantidad o seleccione el lote en la tabla de venta.");
    } else {
        venta.push(productoParaVenta);
    }
    
    e.target.value='';
    renderVenta();
    actualizarCambio();
  }
});

// Actualizar cambio
function actualizarCambio(){
  const metodo = document.getElementById("metodoPago").value;
  if(metodo==="Proveedores") return;
  const total=venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
  const pago=parseFloat(document.getElementById('pagoInput').value)||0;
  document.getElementById('cambioDisplay').value=pago>=total?(pago-total).toFixed(2):"0.00";
}
document.getElementById('pagoInput').addEventListener('input', actualizarCambio);

// Cobrar
document.getElementById("btnCobrar").onclick=()=>{
  if(venta.length===0) return alert("No hay productos en la venta");
  
  // 💡 SINCRONIZACIÓN 5: Validación de lotes seleccionados para antibióticos
  const itemsIncompletos = venta.filter(v => v.categoria && v.categoria.toLowerCase().includes("antibiótico") && (!v.lote || v.cantidad <= 0));
  if(itemsIncompletos.length > 0) return alert("Debe seleccionar un lote y una cantidad válida (>0) para todos los Antibióticos.");
  
  const metodo = document.getElementById("metodoPago").value;
  let total=0;
  // El cálculo del total se hace siempre sobre los productos en venta
  total=venta.reduce((a,v)=>a+v.precio*v.cantidad,0); 

  const ventaData={
    folio:folioCounter++,
    cajero:usuarioActivo,
    fecha:new Date().toLocaleString(),
    productos:venta.map(v => ({ // Solo guarda los datos relevantes del producto
        nombre: v.nombre,
        codigo: v.codigo,
        precio: v.precio,
        cantidad: v.cantidad,
        lote: v.lote || 'N/A',
        caducidad: v.caducidad || 'N/A',
        categoria: v.categoria // Incluye la categoría
    })),
    total:total,
    metodoPago:metodo,
    // MODIFICADO: Corregir el bug del campo "nombreProveedor" no existente en el HTML y usar folioProveedor como nombre si es necesario para el ticket.
    proveedor: metodo === "Proveedores" ? (document.getElementById("folioProveedor").value || "Proveedor sin nombre") : "",
    folioProveedor:metodo==="Proveedores"?document.getElementById("folioProveedor").value:"",
    // DATOS COMPLETOS DE DOCTOR/RECETA
    clienteNombre:document.getElementById("clienteNombre").value,
    clienteCedula:document.getElementById("clienteCedula").value,
    clienteDireccion:document.getElementById("clienteDireccion").value,
    folioReceta:document.getElementById("folioReceta").value
  };
  guardarHistorial(ventaData);
  localStorage.setItem('folioCounter',folioCounter);

  // 💡 SINCRONIZACIÓN 6: Restar stock del lote O stock global
  if(metodo!=="Proveedores"){
    venta.forEach(v=>{ 
      const prod=inventario.find(p=>p.codigo===v.codigo); 
      if(prod){
        // Si es loteado, busca y resta del lote específico
        if(v.categoria && v.categoria.toLowerCase().includes("antibiótico") && v.lote){
            const lote = prod.lotes.find(l => l.lote === v.lote);
            if(lote) lote.stock -= v.cantidad;
        } else {
            // Si no es loteado, resta del stock global
            prod.stock -= v.cantidad;
        }
      }
    });
    guardarInventario();
  }
const ventana=window.open("","Ticket","width=400,height=600");
  const fecha=new Date();
  let html=`<html><head><title>Ticket</title>
  <style>
 body { text-transform: uppercase; font-family:'Courier New',monospace;margin:0;padding:1px;background:#fff;color:#000;font-size:12px;font-weight:bold;line-height:1.0;width:2.0in;margin:1px;}
h2{margin:1px 0;}
   hr{border:colspan;border-top:1px dashed #000;margin:2px 0;}
    td,th{text-transform: uppercase; width:2.0in;margin:0 auto;text-align:left;font-size:10px;font-weight:bold;} 
    .total{font-weight:bold;border-top:1px dashed #000;margin-top:2px;}
    </style>
  </head><body>
  <h2 style="text-align:left; font-size:11px;  text-align:center;">➕FARMACIA Y ORTOPEDIA➕</h2>
  <p style="text-align:left; win">Dirección:Carretera Federal Mexico - Puebla 4m 34.5 Edomex Col Zapopan  CP 56530 Ixtapaluca
</p>
<p>Tel:55-6979-8968 📞</p>
<p> ✆ Tel:55-7883-6807 ✆</p><hr> 
  <p style="text-align:left;">Folio:${ventaData.folio}</p>
  <p style="text-align:left;">Cajero:${usuarioActivo}</p>
  <p style="text-align:left;">Fecha:${fecha.toLocaleString()}</p> 
  <table >
  <thead><tr><th>Producto</th><th>Cant</th><th>Precio</th></tr></thead><tbody>`;
  
  // Imprime productos con sus detalles de lote/caducidad si existen
  ventaData.productos.forEach(v=>{
    html+=`<tr><td>${v.nombre}</td><td>${v.cantidad}</td><td>${v.precio.toFixed(2)}</td></tr>`;
    if(v.lote && v.lote !== 'N/A') html+=`<tr><td colspan="4" style="text-align:left;">Lote:${v.lote}/Cad:${v.caducidad}</td></tr>`;
  });
  
  
  html+=`</tbody></table><p class="total">TOTAL:$${total.toFixed(2)}</p>`;
  if(metodo!=="Proveedores") html+=`<p>PAGO:$${document.getElementById('pagoInput').value}</p><p>CAMBIO: $${document.getElementById('cambioDisplay').value}</p>`;
  if(metodo==="Proveedores") html+=`<p>Proveedor:${ventaData.nombreProv}</p><p>Folio: ${ventaData.folioProveedor}</p>`;
  
  if(venta.some(v=>v.categoria && v.categoria.toLowerCase().includes("antibiótico"))){
    html+=`<hr><p style="text-align:left;"> DATOS DE DOCTOR </p>
           <p style="text-align:left;">Doctor: ${ventaData.clienteNombre}</p>
           <p style="text-align:left;">Cédula: ${ventaData.clienteCedula}</p>
           <p style="text-align:left;">Folio Receta: ${ventaData.folioReceta}</p>`;
  }
  
  html+="<hr><p>¡Gracias por su compra!</p></body></html>";
  ventana.document.write(html);
  ventana.document.close();
  ventana.print();
  
  // Limpiar venta
  venta=[];
  renderVenta();
  document.getElementById("pagoInput").value='';
  document.getElementById("cambioDisplay").value='';
  document.getElementById("clienteNombre").value='';
  document.getElementById("clienteCedula").value='';
  document.getElementById("clienteDireccion").value='';
  document.getElementById("folioReceta").value='';
}

// Logout
document.getElementById("logout").onclick=()=>{ localStorage.removeItem("usuarioActivo"); window.location.href="index.html"; }

// Inicial
renderVenta();
</script>
</body>
</html>


