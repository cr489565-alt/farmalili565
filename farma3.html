<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ’³ Ventas - FarmaciaLili 3.0 ðŸ’³</title>
<style>
body {
  background: #919496;
  color: #1f2937;
  font-family: system-ui, sans-serif;
  margin: 0;
  
  } else {
    const montoProv=parseFloat(document.getElementById("montoProveedor").value)||0;
    document.getElementById('totalVenta').textContent="Monto a pagar: $"+montoProv.toFixed(2);
  }

  guardarVentaActiva();
}

document.getElementById('searchProducto').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const busqueda=e.target.value.trim().toLowerCase();
    if(!busqueda) return;
    const prod=inventario.find(p=>p.codigo.toLowerCase()===busqueda || p.nombre.toLowerCase()===busqueda);
    if(!prod) return alert("Producto no encontrado");
    if(document.getElementById("metodoPago").value!=="Proveedores" && prod.stock<=0)
      return alert("Producto sin stock");
    const existe=venta.find(v=>v.codigo===prod.codigo);
    if(existe){ 
      if(document.getElementById("metodoPago").value!=="Proveedores" && existe.cantidad+1>prod.stock)
        return alert("No hay suficiente stock");
      existe.cantidad++; 
    } else venta.push({...prod,cantidad:1});
    e.target.value=''; renderVenta(); actualizarCambio();
  }
});

function actualizarCambio(){
  const metodo = document.getElementById("metodoPago").value;
  if(metodo==="Proveedores") return;
  const total=venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
  const pago=parseFloat(document.getElementById('pagoInput').value)||0;
  document.getElementById('cambioDisplay').value=pago>=total?(pago-total).toFixed(2):"0.00";
}
document.getElementById('pagoInput').addEventListener('input', actualizarCambio);

function imprimirTicket(ventaData){
  const ventana=window.open("","Ticket","width=400,height=600");
  const fecha=new Date(ventaData.fecha);
  let metodo = document.getElementById("metodoPago").value;
  let html=`<html><head><title>Ticket</title>
  <style>body{font-family:monospace; font-size:5px; text-align:center;} h2{margin:1px 0;} table{width:100%; border-collapse:collapse;} td,th{text-align:left; font-size:6px;} .total{font-weight:bold; border-top:1px dashed #000; margin-top:2px;}</style></head><body>
  <h2>ðŸ’Š Farmacia Ortopedia Lili ðŸ’Š</h2>
  <p>DirecciÃ³n: Calle Salud #123, Ciudad</p>
  <p>Tel: 555-123-4567</p>  <hr>
  <p><strong>Folio:</strong> ${ventaData.folio}</p>
  <p><strong>Fecha:</strong> ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}</p>
  <p><strong>Cajero:</strong> ${ventaData.cajero}</p>
  <hr>
  <table>
  <tr><th>Producto/Proveedor</th><th>CÃ³d</th><th>Cant</th><th>Precio</th></tr>`;

  if(metodo==="Proveedores"){
    ventaData.productos.forEach(p=>{
      html+=`<tr><td>${p.nombre}</td><td>${p.codigo}</td><td>--</td><td>--</td></tr>`;
    });
    html+=`</table><hr>
      <p><strong>Folio Proveedor:</strong> ${document.getElementById("folioProveedor").value||''}</p>
      <p><strong>Monto a pagar:</strong> $${parseFloat(document.getElementById("montoProveedor").value||0).toFixed(2)}</p>`;
  } else {
    ventaData.productos.forEach(p=>{
      html+=`<tr><td>${p.nombre}</td><td>${p.codigo}</td><td>${p.cantidad}</td><td>${p.precio.toFixed(2)}</td></tr>`;
    });
    html+=`</table><hr><p class="total">TOTAL: $${ventaData.total.toFixed(2)}</p>`;
    const antibiotico=ventaData.productos.some(p=>p.codigo.toUpperCase().startsWith("A"));
    if(antibiotico){
      html+=`<hr><p><strong>Receta MÃ©dica</strong></p>
      <p>Doctor: ${document.getElementById("clienteNombre").value||''}</p>
      <p>CÃ©dula: ${document.getElementById("clienteCedula").value||''}</p>
      <p>DirecciÃ³n: ${document.getElementById("clienteDireccion").value||''}</p>
      <p>Folio Receta: ${document.getElementById("folioReceta").value||''}</p>`;
    }
  }

  html+=`<hr><p>Gracias por su compra ðŸ©º</p></body></html>`;
  ventana.document.write(html);
  ventana.print();
  ventana.close();
}

// ðŸ’° Cobrar
document.getElementById("btnCobrar").onclick=()=>{
  if(venta.length===0) return alert("No hay productos en la venta");
  const metodo = document.getElementById("metodoPago").value;
  let total=0;
  if(metodo==="Proveedores"){
    total = parseFloat(document.getElementById("montoProveedor").value)||0;
  } else {
    total = venta.reduce((a,v)=>a+v.precio*v.cantidad,0);
  }

  const ventaData={folio: folioCounter++, cajero: usuarioActivo, fecha:new Date().toLocaleString(), productos: venta, total: total};

  guardarHistorial(ventaData);
  localStorage.setItem('folioCounter',folioCounter);
  imprimirTicket(ventaData);
  venta=[]; renderVenta();
  document.getElementById('pagoInput').value='';
  document.getElementById('montoProveedor').value='';
  document.getElementById('folioProveedor').value='';
  actualizarCambio();
  alert("âœ… Venta cobrada e impresa correctamente.");
};

document.getElementById("logout").onclick=()=>{ localStorage.removeItem("usuarioActivo"); window.location.href="index.html"; };

const panel=document.getElementById("panelReembolso");
document.getElementById("btnReembolso").onclick=()=>{ panel.style.display="flex"; };
document.getElementById("btnCancelar").onclick=()=>{ panel.style.display="none"; };

// Panel de reembolso con contraseÃ±a fija
document.getElementById("btnFinalizar").onclick = () => {
  const folio = document.getElementById("folioVentaInput").value.trim();
  const codigos = document.getElementById("codigoProductoInput").value.trim().split(",").map(c => c.trim());
  const pass = document.getElementById("adminPass").value;

  const CONTRASENA_FIJA = "Mariposa2025";

  if (pass !== CONTRASENA_FIJA) return alert("âŒ ContraseÃ±a incorrecta");
  if (!folio || codigos.length === 0) return alert("âŒ Debes ingresar folio y al menos un cÃ³digo");

  const historial = JSON.parse(localStorage.getItem('ventas')) || [];
  const ventaReemb = historial.find(v => v.folio == folio);
  if (!ventaReemb) return alert("âŒ Folio no encontrado");

  codigos.forEach(codigo => {
    const prodVenta = ventaReemb.productos.find(p => p.codigo === codigo);
    if (prodVenta) {
      const invIndex = inventario.findIndex(p => p.codigo === codigo);
      if (invIndex >= 0) inventario[invIndex].stock += prodVenta.cantidad;
    }
  });

  guardarInventario();
  alert(`âœ… Reembolso realizado para folio ${folio} y productos: ${codigos.join(", ")}`);
  panel.style.display = "none";
};

// Actualiza la tabla al cambiar mÃ©todo de pago
document.getElementById("metodoPago").addEventListener('change', renderVenta);
document.getElementById("montoProveedor").addEventListener('input', renderVenta);

renderVenta();
</script>
</body>
</html>

