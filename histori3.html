<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ“œ Historial - FarmaciaLili 3.0 ğŸ“œ</title>
<style>
body { font-family: system-ui, sans-serif; background:whit; color:#000000; margin:0; padding:0; }
header {background:#fff;color:#000;padding:34px;font-size:26px;font-weight:bold;text-align:center;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
header img{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:250px;height:100px;border-radius:25px;border:0px solid #e5e7eb;}
.main-menu {display:flex;align-items:center;padding:10px;background-color:#68af6b;color:white;}
.menu-link {color:white;text-decoration:none;margin-right:15px;}
.main-menu .menu-link {color:#1f2937;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:500;transition:0.2s;border:1px solid #e5e7eb;}
.main-menu .menu-link:hover {background:#fff;color:#111827;}
.main-menu .menu-link.active {background:#2563eb;color:white;border-color:#2563eb;}
#cajero {margin-left:auto;font-weight:bold;color:#000;}
#logout {background:#dc2626;color:#fff;border:none;border-radius:8px;padding:8px 12px;margin-left:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
#logout:hover {background:#b91c1c; dding:8px 12px;border-radius:8px;cursor:pointer;}
main{padding:1px;display:flex;flex-direction:column;gap:18px;max-width:1200px;margin:0 auto;}
h2{color:#1e3a8a;margin-bottom:8px;}
table{width:100%;border-collapse:collapse;font-size:0.95rem;}
th,td{padding:8px;border-bottom:1px solid #e6eef8;text-align:left;}
th{background:#68af6b; color:white; position:sticky; top:0;}
tfoot td{font-weight:700;background:#f1f8ff;text-align:right;}
.small-muted{font-size:0.9rem;color:#64748b;}
.toggle-btn{background:#0ea5e9;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;margin-top:6px;}
.toggle-btn:hover{opacity:0.95;}
.hidden{display:none;}
.modal {display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:1000;}
.modal-card {width:800px;max-width:300%;height:800px;border-radius:14px;padding:10px;box-shadow:0 8px 40px rgba(2,6,23,0.3);border:1px solid rgba(30,64,175,0.08);background-image:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(240,249,255,0.85)),url("lododoc .png");background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;flex-direction:column;overflow-y:auto;}
.modal-card h3 {margin-bottom:15px;color:#1e40af;text-align:center;text-shadow:0 1px 2px rgba(255,255,255,0.6);}
.modal-card label {display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:10px;}
.modal-card input[type="number"] {width:120px;padding:8px;border-radius:6px;background-color:rgba(255,255,255,0.9);border:1px solid #ccc;}
.modal-card .total-row {margin-top:15px;font-weight:700;color:#000;text-align:right;}
.btn-primary{background:#16a34a;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;margin-top:10px;}
.btn-secondary{background:#ef4444;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;margin-left:8px;}
.note{font-size:0.9rem;color:#475569;margin-top:8px;}
@media (max-width:720px){ header img{display:none;} .modal-card{width:100%;} th,td{font-size:0.85rem;padding:6px;}}
section.card { flex: 1;  overflow-y: auto; overflow-x: auto;   border: 1px solid #4f5256;   border-radius: 5px; background:  linear-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.4)), url('lododoc .png') no-repeat center center;   background-size: auto;  background-position: center; background-attachment:auto ; max-height: 58vh;  box-shadow: inset 0 0 8px rgba(0,0,0,0.2); padding-top: 30px; }
.table-container{width:100%;overflow:auto;margin-top:1px;border-radius:8px; max-height: calc(58vh - 40px - 50px); }
#tabla-historial th, #tabla-historial td { padding: 8px; border-bottom: 1px solid #e6eef8; text-align: left; min-width: 100px; }
#tabla-historial th{ background:#65fd00; color:white;  position: sticky;  top: 0;  z-index: 10;}
.dropdown { position: relative; display: inline-block;}.dropdown-content { display: none;position: absolute; right: 0; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; overflow: hidden;}
.dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block;}
.dropdown-content a:hover { background-color: #f1f1f1;}
.dropdown:hover .dropdown-content { display: block;}
.dropdown:hover .toggle-btn { background-color: #0d95d1;}
.search-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px;}
.search-input { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; width: 250px; min-width: 200px;}
.search-btn { background: #1e40af; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-left: 8px;}
.search-btn:hover { background: #1e3a8a;}
.clear-btn { background: #64748b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-left: 8px;}
.clear-btn:hover { background: #475569;}
#historialSection,#historialCorteSection { display: none;}
.action-row {  text-align:center;  padding: 10px 0; display: flex;  justify-content: flex-end; align-items: center; gap: 15px;flex-wrap: wrap;  background: inherit;}
.action-row label {  margin: 0;  padding: 0;}
.action-row input { width: 100px; padding: 6px 8px; border-radius: 6px; border: 1px solid #9ca3af; font-size: 0.9rem;}
</style>
</head>
<body>
<header>
Â  <img src="lododoc .png" alt="Logo Ventas">
Â  ğŸ“œ Historial - FarmaciaLili 3.0 ğŸ“œ 
</header>

<nav class="main-menu">
<a href="farma3.html" class="menu-link ">ğŸ’³ Ventas</a>
Â <a href="inve3.html" class="menu-link">ğŸ“¦ Inventario</a>
Â <a href="histori3.html" class="menu-link active">ğŸ“œ Historial</a>
Â  
Â  <div class="dropdown">
Â  Â  <button class="toggle-btn">ğŸ“‹ Opciones</button>
Â  Â  <div class="dropdown-content">
Â  Â  Â  <a href="#" onclick="toggleHistorial()">ğŸ“‚ Historial de ventas ğŸ“‚</a>
Â  Â  Â  <a href="#" onclick="toggleHistorialCorte()">ğŸ“‹ Historial de Corte ğŸ“‹</a>
Â  Â  </div>
Â  </div>
Â  
Â  <span id="cajero"></span>
Â  <button id="logout">Cerrar SesiÃ³n</button>
</nav>

<main>
Â  <section class="card">
Â  Â  <h2>ğŸ’µ Ventas Generales </h2>
Â  Â  <div class="small-muted"> <code></code> Â <code></code>.</div>
    Â  Â  <div class="table-container">
Â  Â  Â  <table id="tabla-ventas-general">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr><th>#</th><th>CÃ³digo</th><th>Producto</th><th>Cantidad</th><th>CategorÃ­a</th><th>Folio Tiket</th><th>Folio Proveedor</th><th>Doctor</th><th>CÃ©dula</th><th>Folio Receta</th><th>Fecha y Hora</th><th>Cajero</th><th>MÃ©todo de Pago</th><th>Subtotal</th></tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  <tfoot>
            <tr>
                <td colspan="12" style="text-align: left; padding: 8px;">
                    <div class="action-row" style="justify-content: flex-start; padding: 0;">
                    </div>
                </td>
                <td style="text-align: right; font-weight: bold;">Total General</td>
                <td id="total-general" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="12"></td>
                <td style="text-align: right; font-weight: bold;">Total sin Proveedor</td>
                <td id="total-sin-proveedor" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="12"></td>
                <td style="text-align: right; font-weight: bold;">Total Proveedor</td>
                <td id="total-proveedor" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="14" style="text-align: center; padding: 10px 0;">
                    <button class="btn-primary" onclick="abrirModalCorte()">ğŸ’° Realizar Corte</button>
                </td>
            </tr>
        </tfoot>
Â  Â  Â  </table>
Â  Â  </div>
Â  </section>

Â  Â  <section class="card" id="historialSection">
Â  Â  <h2>ğŸ“‚ Historial de Ventas Completas ğŸ“‚</h2>
Â  Â  <div class="search-container">
Â  Â  Â  <div>
Â  Â  Â  Â  <input type="text" id="searchInput" class="search-input" placeholder="Buscar por Folio, Producto, CÃ³digo, Doctor, etc...">
Â  Â  Â  Â  <button onclick="buscarHistorial()" class="search-btn">ğŸ” Buscar</button>
Â  Â  Â  Â  <button onclick="descargarpdf()" class="clear-btn">descargarPDF</button>
Â  Â  Â  </div>
Â  Â  </div>
    Â  Â  <div class="table-container">
Â  Â  Â  <table id="tabla-historial">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr><th>#</th><th>CÃ³digo</th><th>Producto</th><th>Cantidad</th><th>CategorÃ­a</th><th>Folio Tiket</th><th>Folio Proveedor</th><th>Doctor</th><th>CÃ©dula</th><th>Folio Receta</th><th>Fecha y Hora</th><th>Cajero</th><th>MÃ©todo de Pago</th><th>Subtotal</th></tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </section>

Â  <section class="card" id="historialCorteSection">
Â  Â  <h2>ğŸ“‹ Historial de Corte de Caja Ajustado ğŸ“‹</h2>
    Â  Â  <div class="table-container">
Â  Â  Â  <table id="tabla-historial-corte">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>#</th>
             <th>Fecha y Hora</th>
             <th>Cajero</th>
             <th>Inicio Caja</th>
             <th>Total G. Efectivo</th>
             <th>Total G. Tarjeta</th>
             <th>Total G. Transferencia</th>
             <th>Total G. Proveedor</th>
             <th>Efectivo Neto</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </section>
</main>

<div class="modal" id="modalCorte">
Â  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
Â  Â  <h3 id="modalTitle">ğŸ’µ Panel de Corte</h3>
Â  Â  <label style="margin-top:8px;">Cantidad Inicio Caja: <input id="inicioCaja" type="number" value="0" step="0.01" readonly style="padding:6px;border-radius:6px;border:1px solid #c7ddff; background-color: #e2e8f0;"></label>
Â  Â  <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;">
Â  Â  Â  <label>ğŸ’µ 1000: <input class="billete" data-valor="1000" type="number" value="0"></label>
Â  Â  Â  <label>ğŸ’µ 500: Â <input class="billete" data-valor="500" type="number" value="0"></label>
Â  Â  Â  <label>ğŸ’µ 200: Â <input class="billete" data-valor="200" type="number" value="0"></label>
Â  Â  Â  <label>ğŸ’µ 100: Â <input class="billete" data-valor="100" type="number" value="0"></label>
Â  Â  Â  <label>ğŸ’µ 50: Â  <input class="billete" data-valor="50" type="number" value="0"></label>
Â  Â  Â  <label>ğŸ’µ 20: Â  <input class="billete" data-valor="20" type="number" value="0"></label>
Â  Â  Â  <label>ğŸª™ 10: Â  <input class="billete" data-valor="10" type="number" value="0"></label>
Â  Â  Â  <label>ğŸª™ 5: Â  Â <input class="billete" data-valor="5" type="number" value="0"></label>
Â  Â  Â  <label>ğŸª™ 2: Â  Â <input class="billete" data-valor="2" type="number" value="0"></label>
Â  Â  Â  <label>ğŸª™ 1: Â  Â <input class="billete" data-valor="1" type="number" value="0"></label>
Â  Â  Â  <label>ğŸª™ 0.50: <input class="billete" data-valor="0.5" type="number" value="0"></label>
Â  Â  </div>

Â  Â  <div class="total-row">Total Contado (Efectivo en Caja): <span id="totalEfectivoContado">$0.00</span></div>
Â  Â  
Â  Â  <div style="margin-top:15px; padding:10px; background:#f0f9ff; border-radius:8px;">
Â  Â  Â  <h4 style="margin:0 0 10px; color:#1e40af; text-align: center; font-weight: bold;">ğŸ“Š Resumen de Ventas por MÃ©todo de Pago:</h4>
Â  Â  Â  <div style="display:flex; flex-wrap:wrap; gap:15px;">
Â  Â  Â  Â  <div style="flex:1; min-width:150px;">
            <p style="margin:5px 0; font-weight:bold;">Inicio Caja: <span id="resumenInicioCaja">$0.00</span></p>
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">Ventas Efectivo: <span id="resumenEfectivo">$0.00</span></p>
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">Ventas Tarjeta: <span id="resumenTarjeta">$0.00</span></p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="flex:1; min-width:150px;">
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">Ventas Transferencia: <span id="resumenTransferencia">$0.00</span></p>
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">Ventas Proveedores: <span id="resumenProveedor">$0.00</span></p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
      
      <hr style="border:0; border-top:1px dashed #c7ddff; margin: 10px 0;">

      <h4 style="margin:0 0 10px; color:#1e40af; text-align: center; font-weight: bold;">ğŸ’° Totales Generales Calculados:</h4>
      <div style="display:flex; flex-wrap:wrap; gap:15px; background:#e0f2fe; padding:8px; border-radius:6px;">
Â  Â  Â  Â  <div style="flex:1; min-width:150px;">
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold; color:#0369a1;">TOTAL GENERAL EFECTIVO (V.Efectivo - V.Proveedor): <span id="totalGeneralEfectivo">$0.00</span></p>
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL TARJETA: <span id="totalGeneralTarjeta">$0.00</span></p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="flex:1; min-width:150px;">
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL TRANSFERENCIA: <span id="totalGeneralTransferencia">$0.00</span></p>
Â  Â  Â  Â  Â  <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL PROVEEDOR: <span id="totalGeneralProveedor">$0.00</span></p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

      <hr style="border:0; border-top:2px solid #0369a1; margin: 15px 0;">

      <div class="total-row" style="font-size:1.1rem; color:#b91c1c;">
        EFECTIVO NETO (Contado - Inicio Caja): <span id="efectivoNeto">$0.00</span>
      </div>
Â  Â  </div>

Â  Â  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
Â  Â  Â  <button class="btn-primary" onclick="finalizarCorte()">âœ… Finalizar Corte e Imprimir</button>
Â  Â  Â  <button class="btn-secondary" onclick="cerrarModalCorte()">âŒ Cerrar</button>
Â  Â  </div>
Â  </div>
</div>

<script>
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(usuarioActivo){
Â  document.getElementById("cajero").textContent = "ğŸ‘¤ Cajero: " + usuarioActivo;
}

// ContraseÃ±a para el historial de corte (Pista: 1234)
const CONTRASENA_CORTE = "1234"; 

function parseJSON(key){ 
Â  try{ 
Â  Â  return JSON.parse(localStorage.getItem(key)||"[]"); 
Â  }catch(e){ 
Â  Â  console.warn(`Error al parsear ${key}:`, e);
Â  Â  return []; 
Â  } 
}

function setJSON(key,val){ 
Â  localStorage.setItem(key, JSON.stringify(val)); 
}

function formatDinero(n){ 
Â  return "$" + (Number(n||0)).toFixed(2); 
}

// FunciÃ³n para cerrar sesiÃ³n
function cerrarSesion() {
Â  localStorage.removeItem("usuarioActivo");
Â  window.location.href = "index.html";
}

// Evento para el botÃ³n de cerrar sesiÃ³n
document.getElementById("logout").addEventListener("click", cerrarSesion);

// FunciÃ³n para cargar las ventas no cortadas (simplificada)
function cargarTodasLasVentas(){
Â  const ventas = parseJSON('ventas');
Â  return ventas.filter(venta => venta.productos && venta.productos.length > 0);
}

function renderVentas(){
Â  const ventas = cargarTodasLasVentas();
Â  const tbodyG = document.querySelector("#tabla-ventas-general tbody");
Â  tbodyG.innerHTML = ""; 
Â  let totalG = 0;
    let totalSinProveedor = 0; 
    let totalProveedor = 0; 
Â  let idxG = 1;
Â  
Â  ventas.forEach(v=>{
Â  Â  (v.productos||[]).forEach(item=>{
Â  Â  Â  const subtotal = (Number(item.precio) || 0) * (Number(item.cantidad) || 0);
Â  Â  Â  
Â  Â  Â  // Llenar tabla Ventas Generales
Â  Â  Â  const trG = document.createElement('tr');
Â  Â  Â  trG.innerHTML = `<td>${idxG++}</td>
Â  Â  Â  Â  <td>${item.codigo||'-'}</td>
Â  Â  Â  Â  <td>${item.nombre||'-'}</td>
Â  Â  Â  Â  <td>${item.cantidad||0}</td>
Â  Â  Â  Â  <td>${item.categoria||'-'}</td>
Â  Â  Â  Â  <td>${v.folio||'-'}</td>
Â  Â  Â  Â  <td>${v.folioProveedor||'-'}</td>
Â  Â  Â  Â  <td>${v.clienteNombre||'-'}</td>
Â  Â  Â  Â  <td>${v.clienteCedula||'-'}</td>
Â  Â  Â  Â  <td>${v.folioReceta||'-'}</td>
Â  Â  Â  Â  <td>${v.fecha||'-'}</td>
Â  Â  Â  Â  <td>${v.cajero||'-'}</td>
Â  Â  Â  Â  <td>${v.metodoPago||'-'}</td>
Â  Â  Â  Â  <td style="text-align: right;">${formatDinero(subtotal)}</td>`;
Â  Â  Â  tbodyG.appendChild(trG);
Â  Â  Â  totalG += subtotal;

      // CÃ¡lculo de nuevos totales (Proveedores y Sin Proveedor)
      if (v.metodoPago === 'Proveedores') {
          totalProveedor += subtotal;
      } else {
          totalSinProveedor += subtotal;
      }
Â  Â  });
Â  });

Â  document.getElementById('total-general').textContent = formatDinero(totalG);
    document.getElementById('total-sin-proveedor').textContent = formatDinero(totalSinProveedor);
    document.getElementById('total-proveedor').textContent = formatDinero(totalProveedor);
    
    // Cargar Inicio de Caja temporal en el input de Ventas Generales
    const inicioGuardado = localStorage.getItem('inicioCajaTemporal');
    const inputInicioTemp = document.getElementById('inicioCajaTemp');
    const btnFijar = document.querySelector('.btn-save-temp');
    
    if(inicioGuardado !== null && !isNaN(parseFloat(inicioGuardado))) {
        inputInicioTemp.value = parseFloat(inicioGuardado).toFixed(2);
        inputInicioTemp.readOnly = true;
        inputInicioTemp.style.backgroundColor = '#d1fae5';
        btnFijar.textContent = 'âœ… Fijado';
        btnFijar.disabled = true;
    } else {
        inputInicioTemp.value = '0.00';
        inputInicioTemp.readOnly = false;
        inputInicioTemp.style.backgroundColor = '';
        btnFijar.textContent = 'ğŸ’¾ Fijar';
        btnFijar.disabled = false;
    }
}

function guardarInicioCajaTemporal() {
    const inputInicioTemp = document.getElementById('inicioCajaTemp');
    const btnFijar = document.querySelector('.btn-save-temp');
    const valor = parseFloat(inputInicioTemp.value) || 0;
    
    // Validar y guardar el valor
    localStorage.setItem('inicioCajaTemporal', valor.toFixed(2));
    
    // Fijar la apariencia
    inputInicioTemp.readOnly = true;
    inputInicioTemp.style.backgroundColor = '#d1fae5';
    btnFijar.textContent = 'âœ… Fijado';
    btnFijar.disabled = true;
    
    alert(`Inicio de Caja ($${valor.toFixed(2)}) guardado y fijado para el corte.`);
}

function handleInicioCajaKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        guardarInicioCajaTemporal();
    }
}


function renderHistorialCompleto() {
Â  const ventasCorte = parseJSON('ventasCorte');
Â  const tbody = document.querySelector("#tabla-historial tbody");
Â  tbody.innerHTML = "";
Â  let idx = 1;
Â  
Â  ventasCorte.forEach(item => {
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${idx++}</td>
Â  Â  Â  <td>${item.codigo||'-'}</td>
Â  Â  Â  <td>${item.producto||'-'}</td>
Â  Â  Â  <td>${item.cantidad||0}</td>
Â  Â  Â  <td>${item.categoria||'-'}</td>
Â  Â  Â  <td>${item.folio||'-'}</td>
Â  Â  Â  <td>${item.folioProveedor||'-'}</td>
Â  Â  Â  Â  <td>${item.doctor||'-'}</td>
Â  Â  Â  Â  <td>${item.cedula||'-'}</td>
Â  Â  Â  Â  <td>${item.receta||'-'}</td>
Â  Â  Â  Â  <td>${item.fecha||'-'}</td>
Â  Â  Â  Â  <td>${item.cajero||'-'}</td>
Â  Â  Â  Â  <td>${item.metodo||'-'}</td>
Â  Â  Â  Â  <td style="text-align: right;">${formatDinero(item.subtotal)}</td>`;
Â  Â  tbody.appendChild(tr);
Â  });
}

function buscarHistorial() {
Â  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
Â  const ventasCorte = parseJSON('ventasCorte');
Â  const tbody = document.querySelector("#tabla-historial tbody");
Â  tbody.innerHTML = "";
Â  let idx = 1;
Â  
Â  ventasCorte.forEach(item => {
Â  Â  const searchableString = [
Â  Â  Â  item.producto, item.codigo, item.categoria, item.folio, item.folioProveedor, 
Â  Â  Â  item.doctor, item.cedula, item.receta, item.fecha, item.cajero, item.metodo,
Â  Â  ].join(' ').toLowerCase();
Â  Â  
Â  Â  if (searchableString.includes(searchTerm)) {
Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  tr.innerHTML = `<td>${idx++}</td>
Â  Â  Â  Â  <td>${item.codigo||'-'}</td>
Â  Â  Â  Â  <td>${item.producto||'-'}</td>
Â  Â  Â  Â  <td>${item.cantidad||0}</td>
Â  Â  Â  Â  <td>${item.categoria||'-'}</td>
Â  Â  Â  Â  <td>${item.folio||'-'}</td>
Â  Â  Â  Â  <td>${item.folioProveedor||'-'}</td>
Â  Â  Â  Â  <td>${item.doctor||'-'}</td>
Â  Â  Â  Â  <td>${item.cedula||'-'}</td>
Â  Â  Â  Â  <td>${item.receta||'-'}</td>
Â  Â  Â  Â  <td>${item.fecha||'-'}</td>
Â  Â  Â  Â  <td>${item.cajero||'-'}</td>
Â  Â  Â  Â  <td>${item.metodo||'-'}</td>
Â  Â  Â  Â  <td style="text-align: right;">${formatDinero(item.subtotal)}</td>`;
Â  Â  Â  tbody.appendChild(tr);
Â  Â  }
Â  });
Â  
Â  if (tbody.children.length === 0) {
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td colspan="14" style="text-align:center; padding:20px;">No se encontraron resultados para "${searchTerm}"</td>`;
Â  Â  tbody.appendChild(tr);
Â  }
}

function limpiarBusqueda() {
Â  document.getElementById('searchInput').value = '';
Â  renderHistorialCompleto();
}

function toggleHistorial() {
Â  const historialSection = document.getElementById('historialSection');
Â  const historialCorteSection = document.getElementById('historialCorteSection');
Â  
Â  if (historialSection.style.display === 'none' || historialSection.style.display === '') {
Â  Â  historialSection.style.display = 'block';
Â  Â  historialCorteSection.style.display = 'none';
Â  Â  renderHistorialCompleto();
Â  } else {
Â  Â  historialSection.style.display = 'none';
Â  }
}

// FUNCIÃ“N CLAVE: Muestra el panel de contraseÃ±a y luego el historial de corte
function toggleHistorialCorte() {
    const historialSection = document.getElementById('historialSection');
    const historialCorteSection = document.getElementById('historialCorteSection');
    
    // Si la secciÃ³n ya estÃ¡ visible, la ocultamos sin pedir contraseÃ±a
    if (historialCorteSection.style.display === 'block') {
        historialCorteSection.style.display = 'none';
        return;
    }

    // Pedir contraseÃ±a
    const password = prompt("Ingrese la contraseÃ±a para ver el Historial de Corte ");

    if (password === CONTRASENA_CORTE) {
        historialCorteSection.style.display = 'block';
        historialSection.style.display = 'none';
        renderHistorialCorte();
    } else {
        alert("ContraseÃ±a incorrecta. Acceso denegado.");
        historialCorteSection.style.display = 'none';
    }
}

function renderHistorialCorte() {
Â  const cortes = parseJSON('cortes');
Â  const tbody = document.querySelector("#tabla-historial-corte tbody");
Â  tbody.innerHTML = "";
Â  let idx = 1;
Â  
Â  cortes.forEach(corte => {
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${idx++}</td>
Â  Â  Â  <td>${corte.fecha||'-'}</td>
Â  Â  Â  <td>${corte.cajero||'-'}</td>
Â  Â  Â  <td>${formatDinero(corte.inicioCaja||0)}</td>
Â  Â  Â  <td>${formatDinero(corte.totalGeneralEfectivo||0)}</td>
Â  Â  Â  <td>${formatDinero(corte.tarjeta||0)}</td>
Â  Â  Â  <td>${formatDinero(corte.transferencia||0)}</td>
Â  Â  Â  <td>${formatDinero(corte.proveedor||0)}</td>
Â  Â  Â  <td style="text-align: right;">${formatDinero(corte.efectivoNeto||0)}</td>`;
Â  Â  tbody.appendChild(tr);
Â  });
}

// ---------- Modal Corte ----------

function abrirModalCorte(){
Â  document.getElementById('modalCorte').style.display = 'flex';
Â  
Â  // 1. Cargar valor guardado de inicio de caja (del input 'inicioCajaTemp' fijado)
Â  const inicioGuardado = localStorage.getItem('inicioCajaTemporal');
Â  const inputInicioModal = document.getElementById('inicioCaja');
Â  
Â  if(inicioGuardado !== null && !isNaN(parseFloat(inicioGuardado))) {
Â  Â  inputInicioModal.value = parseFloat(inicioGuardado).toFixed(2);
Â  } else {
    inputInicioModal.value = '0.00';
Â  }
Â  
Â  // 2. Calcular y mostrar los totales por mÃ©todo de pago INMEDIATAMENTE
Â  calcularTotalesMetodosPago();
Â  
Â  // 3. Reiniciar los campos de billetes
Â  document.querySelectorAll('.billete').forEach(b => b.value = '0');
Â  document.getElementById('totalEfectivoContado').textContent = '$0.00';
  document.getElementById('efectivoNeto').textContent = '$0.00'; 
}

function cerrarModalCorte(){
Â  document.getElementById('modalCorte').style.display = 'none';
}

function calcularTotalesMetodosPago(){
Â  const ventas = cargarTodasLasVentas();
Â  
Â  let totalEfectivo = 0;
Â  let totalTarjeta = 0;
Â  let totalTransferencia = 0;
Â  let totalProveedor = 0;
Â  
Â  ventas.forEach(v => {
Â  Â  const metodo = v.metodoPago || 'Efectivo';
Â  Â  const subtotal = (v.productos || []).reduce((sum, item) => sum + (Number(item.precio || 0) * Number(item.cantidad || 0)), 0);
Â  Â  
Â  Â  switch(metodo) {
Â  Â  Â  case 'Efectivo':
Â  Â  Â  Â  totalEfectivo += subtotal;
Â  Â  Â  Â  break;
Â  Â  Â  case 'Tarjeta':
Â  Â  Â  Â  totalTarjeta += subtotal;
Â  Â  Â  Â  break;
Â  Â  Â  case 'Transferencia':
Â  Â  Â  Â  totalTransferencia += subtotal;
Â  Â  Â  Â  break;
Â  Â  Â  case 'Proveedores':
Â  Â  Â  Â  totalProveedor += subtotal;
Â  Â  Â  Â  break;
Â  Â  Â  default:
Â  Â  Â  Â  totalEfectivo += subtotal;
Â  Â  }
Â  });
Â  
    // Obtener el valor de Inicio de Caja
    const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;

    // Mostrar Resumen
    document.getElementById('resumenInicioCaja').textContent = formatDinero(inicioCaja); 
Â    document.getElementById('resumenEfectivo').textContent = formatDinero(totalEfectivo);
Â    document.getElementById('resumenTarjeta').textContent = formatDinero(totalTarjeta);
Â    document.getElementById('resumenTransferencia').textContent = formatDinero(totalTransferencia);
Â    document.getElementById('resumenProveedor').textContent = formatDinero(totalProveedor);

    // Totales Generales Calculados
    const totalGeneralEfectivo = totalEfectivo - totalProveedor;

    document.getElementById('totalGeneralEfectivo').textContent = formatDinero(totalGeneralEfectivo);
    document.getElementById('totalGeneralTarjeta').textContent = formatDinero(totalTarjeta);
    document.getElementById('totalGeneralTransferencia').textContent = formatDinero(totalTransferencia);
    document.getElementById('totalGeneralProveedor').textContent = formatDinero(totalProveedor);

    // Recalcular Efectivo Neto (Contado - Inicio Caja)
    calcularTotalEfectivo(true);
}

function calcularTotalEfectivo(skipUpdateMetodosPago = false) {
Â  const billetes = document.querySelectorAll('.billete');
Â  let totalEContado = 0;
Â  billetes.forEach(b => {
Â  Â  totalEContado += Number(b.value || 0) * Number(b.dataset.valor || 0);
Â  });
Â  document.getElementById('totalEfectivoContado').textContent = formatDinero(totalEContado);

  // Calcular Efectivo Neto
  const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;
  const efectivoNeto = totalEContado - inicioCaja;
  document.getElementById('efectivoNeto').textContent = formatDinero(efectivoNeto);
}

// Eventos para los inputs en el modal
document.querySelectorAll('.billete').forEach(b => {
Â  b.addEventListener('input', () => calcularTotalEfectivo(false)); 
});

function finalizarCorte(){
Â  // 1. Valores de entrada y conteo
Â  const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;
Â  const billetes = document.querySelectorAll('.billete');
Â  let efectivoContado = 0;
Â  billetes.forEach(b => efectivoContado += Number(b.value || 0) * Number(b.dataset.valor || 0));
Â  
Â  // 2. Totales de Ventas (Tomados del resumen)
Â  const efectivoVentas = parseFloat(document.getElementById('resumenEfectivo').textContent.replace('$', '')) || 0;
Â  const tarjeta = parseFloat(document.getElementById('resumenTarjeta').textContent.replace('$', '')) || 0;
Â  const transferencia = parseFloat(document.getElementById('resumenTransferencia').textContent.replace('$', '')) || 0;
Â  const proveedor = parseFloat(document.getElementById('resumenProveedor').textContent.replace('$', '')) || 0;
Â  
Â  // 3. Totales Generales Calculados
Â  const totalGeneralEfectivo = efectivoVentas - proveedor;
Â  const efectivoNeto = efectivoContado - inicioCaja; 
Â  const totalGeneral = totalGeneralEfectivo + tarjeta + transferencia;

Â  // Guardar el corte
Â  const cortes = parseJSON('cortes');
Â  cortes.push({
Â  Â  fecha: new Date().toLocaleString(), 
Â  Â  cajero: usuarioActivo, 
Â  Â  inicioCaja: inicioCaja,
Â  Â  efectivoContado: efectivoContado, 
Â  Â  efectivoVentas: efectivoVentas, 
Â  Â  tarjeta: tarjeta, 
Â  Â  transferencia: transferencia, 
Â  Â  proveedor: proveedor, 
Â  Â  totalGeneralEfectivo: totalGeneralEfectivo, 
Â  Â  efectivoNeto: efectivoNeto, 
Â  Â  total: totalGeneral
Â  });
Â  setJSON('cortes', cortes);

Â  const ventas = cargarTodasLasVentas(); 
Â  const ventasCorte = parseJSON('ventasCorte');
Â  
Â  // Mover las ventas activas al historial
Â  ventas.forEach(v => {
Â  Â  v.productos.forEach(item => {
Â  Â  Â  ventasCorte.push({
Â  Â  Â  Â  producto: item.nombre,
Â  Â  Â  Â  codigo: item.codigo,
Â  Â  Â  Â  cantidad: item.cantidad,
Â  Â  Â  Â  categoria: item.categoria || '', 
Â  Â  Â  Â  folio: v.folio, 
Â  Â  Â  Â  folioProveedor: v.folioProveedor || '', 
Â  Â  Â  Â  doctor: v.clienteNombre || '', 
Â  Â  Â  Â  cedula: v.clienteCedula || '', 
Â  Â  Â  Â  receta: v.folioReceta || '', 
Â  Â  Â  Â  fecha: v.fecha, 
Â  Â  Â  Â  cajero: v.cajero,
Â  Â  Â  Â  metodo: v.metodoPago, 
Â  Â  Â  Â  subtotal: (item.precio * item.cantidad) 
Â  Â  Â  });
Â  Â  });
Â  });
Â  
Â  setJSON('ventasCorte', ventasCorte);

Â  // Vaciar solo la clave de ventas activas 'ventas'
Â  localStorage.setItem('ventas', JSON.stringify([]));

Â  // Limpiar inicio de caja temporal y el input de la pÃ¡gina (resetear el estado de fijado)
Â  localStorage.removeItem('inicioCajaTemporal');
  document.getElementById('inicioCajaTemp').value = '0.00';
  document.getElementById('inicioCajaTemp').readOnly = false;
  document.getElementById('inicioCajaTemp').style.backgroundColor = '';
  document.querySelector('.btn-save-temp').textContent = 'ğŸ’¾ Fijar';
  document.querySelector('.btn-save-temp').disabled = false;


Â  // Imprimir ticket
Â  imprimirTicketCorte(
    inicioCaja, 
    efectivoContado, 
    tarjeta, 
    transferencia, 
    proveedor, 
    totalGeneral,
    efectivoVentas, 
    totalGeneralEfectivo, 
    efectivoNeto 
  );

Â  cerrarModalCorte();
Â  
Â  // Actualizar la vista de la tabla de ventas (vacÃ­a)
Â  renderVentas();
Â  
Â  // Cerrar sesiÃ³n
Â  cerrarSesion();
}

function imprimirTicketCorte(inicioCaja, efectivo, tarjeta, transferencia, proveedor, totalGeneral) {
  const ventana = window.open("","Ticket","width=300,height=600");
  const fecha = new Date().toLocaleString();
  
  let html = `<html><head><title>Ticket de Corte</title>
  <style>
    body { 
      font-family: 'Courier New', monospace; 
      margin: 0; 
      padding: 10px; 
      background-color: #fff; 
      color: #000;
      font-size: 10px;
      line-height: 1.2;
      width: 2.2in;
      margin: 0 auto;
    }
    .ticket-header {
      text-align: center;
      padding: 5px 0;
      border-bottom: 1px solid #000;
      margin-bottom: 10px;
    }
    .ticket-header h2 {
      margin: 3px 0;
      font-size: 14px;
      color: #000;
    }
    .ticket-header p {
      margin: 2px 0;
      font-size: 9px;
    }
    .info-container {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 10px;
    }
    .info-container div {
      margin: 2px 0;
    }
    .info-container strong {
      color: #000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 10px;
    }
    th, td {
      padding: 4px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f0f0f0;
      color: #000;
    }
    .total-row {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .resumen-row {
      font-weight: bold;
      margin: 5px 0;
    }
    .footer {
      text-align: center;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #000;
      font-style: italic;
      color: #000;
      font-size: 9px;
    }
    .center { text-align: center; }
    .right { text-align: right; }
    .bold { font-weight: bold; }
  </style>
  </head><body>
  <div class="ticket-header">
    <h2>ğŸ’Š FarmaciaLili - Corte ğŸ’Š</h2>
    <p>Farmacia Copias, Manzana 012</p>
    <p>56589 Zoquiapan, MÃ©x</p>
    <p>Tel: 55 7883 6807</p>
  </div>
  
  <div class="info-container">
    <div>
      <div><strong>Fecha:</strong> ${fecha}</div>
    </div>
    <div>
      <div><strong>Cajero:</strong> ${usuarioActivo}</div>
    </div>
  </div>
  
  <div class="resumen-row">
    <p><strong>Inicio Caja:</strong> ${formatDinero(inicioCaja)}</p>
    <p><strong>Efectivo:</strong> ${formatDinero(efectivo)}</p>
    <p><strong>Tarjeta:</strong> ${formatDinero(tarjeta)}</p>
    <p><strong>Transferencia:</strong> ${formatDinero(transferencia)}</p>
    <p><strong>Proveedores:</strong> ${formatDinero(proveedor)}</p>
    <p><strong>Total Neto:</strong> ${formatDinero(totalGeneral)}</p>
  </div>
  <br>
  <div class="footer">
    FIRRNA JEFE 
    <p> âœ… Corte Finalizado âœ… </p>
    <p> ğŸ©º Gracias por su confianza ğŸ©º </p>
  </div>
  </body></html>`;
  
  ventana.document.write(html);
  ventana.print();
  ventana.close();
}

// InicializaciÃ³n
renderVentas();

// Asegurar que el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', function() {
Â  // Evento para bÃºsqueda en tiempo real
Â  document.getElementById('searchInput').addEventListener('input', function() {
Â  Â  if (this.value.trim() === '') {
Â  Â  Â  renderHistorialCompleto();
Â  Â  } else {
Â  Â  Â  buscarHistorial();
Â  Â  }
Â  });
});
</script>
</body>
</html>

