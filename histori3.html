<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>📜 Historial - FarmaciaLili 3.1 📜</title>
<style>
body { font-family: system-ui, sans-serif; background:whit; color:#000000; margin:0; padding:0; }
header {background:#fff;color:#000;padding:34px;font-size:26px;font-weight:bold;text-align:center;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
header img{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:250px;height:100px;border-radius:25px;border:0px solid #e5e7eb;}
.main-menu {display:flex;align-items:center;padding:10px;background-color:#68af6b;color:white;}
.menu-link {color:white;text-decoration:none;margin-right:15px;}
.main-menu .menu-link {color:#1f2937;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:500;transition:0.2s;border:1px solid #e5e7eb;}
.main-menu .menu-link:hover {background:#fff;color:#111827;}
.main-menu .menu-link.active {background:#2563eb;color:white;border-color:#2563eb;}
#cajero {margin-left:auto;font-weight:bold;color:#000;}
#logout {background:#dc2626;color:#fff;border:none;border-radius:8px;padding:8px 12px;margin-left:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
#logout:hover {background:#b91c1c; dding:8px 12px;border-radius:8px;cursor:pointer;}
main{padding:1px;display:flex;flex-direction:column;gap:18px;max-width:1200px;margin:0 auto;}
h2{color:#1e3a8a;margin-bottom:8px;}
table{width:100%;border-collapse:collapse;font-size:0.95rem;}
th,td{padding:8px;border-bottom:1px solid #e6eef8;text-align:left;}
th{background:#68af6b; color:white; position:sticky; top:0;}
tfoot td{font-weight:700;background:#f1f8ff;text-align:right;}
.small-muted{font-size:0.9rem;color:#64748b;}
.toggle-btn{background:#0ea5e9;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;margin-top:6px;}
.toggle-btn:hover{opacity:0.95;}
.hidden{display:none;}
.modal {display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:1000;}
.modal-card {width:800px;max-width:300%;height:800px;border-radius:14px;padding:10px;box-shadow:0 8px 40px rgba(2,6,23,0.3);border:1px solid rgba(30,64,175,0.08);background-image:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(240,249,255,0.85)),url("lododoc .png");background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;flex-direction:column;overflow-y:auto;}
.modal-card h3 {margin-bottom:15px;color:#1e40af;text-align:center;text-shadow:0 1px 2px rgba(255,255,255,0.6);}
.modal-card label {display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:10px;}
.modal-card input[type="number"] {width:120px;padding:8px;border-radius:6px;background-color:rgba(255,255,255,0.9);border:1px solid #ccc;}
.modal-card .total-row {margin-top:15px;font-weight:700;color:#000;text-align:right;}
.btn-primary{background:#16a34a;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;margin-top:10px;}
.btn-secondary{background:#ef4444;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;margin-left:8px;}
.note{font-size:0.9rem;color:#475569;margin-top:8px;}
@media (max-width:720px){ header img{display:none;} .modal-card{width:100%;} th,td{font-size:0.85rem;padding:6px;}}
section.card { flex: 1;  overflow-y: auto; overflow-x: auto;   border: 1px solid #4f5256;   border-radius: 5px; background:  linear-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.4)), url('lododoc .png') no-repeat center center;   background-size: auto;  background-position: center; background-attachment:auto ; max-height: 58vh;  box-shadow: inset 0 0 8px rgba(0,0,0,0.2); padding-top: 30px; }
.table-container{width:100%;overflow:auto;margin-top:1px;border-radius:8px; max-height: calc(58vh - 40px - 50px); }
#tabla-historial th, #tabla-historial td { padding: 8px; border-bottom: 1px solid #e6eef8; text-align: left; min-width: 100px; }
#tabla-historial th{ background:#65fd00; color:white;  position: sticky;  top: 0;  z-index: 10;}
.dropdown { position: relative; display: inline-block;}.dropdown-content { display: none;position: absolute; right: 0; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; overflow: hidden;}
.dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block;}
.dropdown-content a:hover { background-color: #f1f1f1;}
.dropdown:hover .dropdown-content { display: block;}
.dropdown:hover .toggle-btn { background-color: #0d95d1;}
.search-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px;}
.search-input { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; width: 250px; min-width: 200px;}
.search-btn { background: #1e40af; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-left: 8px;}
.search-btn:hover { background: #1e3a8a;}
.clear-btn { background: #64748b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-left: 8px;}
.clear-btn:hover { background: #475569;}
#historialSection,#historialCorteSection { display: none;}
.action-row {  text-align:center;  padding: 10px 0; display: flex;  justify-content: flex-end; align-items: center; gap: 15px;flex-wrap: wrap;  background: inherit;}
.action-row label {  margin: 0;  padding: 0;}
.action-row input { width: 100px; padding: 6px 8px; border-radius: 6px; border: 1px solid #9ca3af; font-size: 0.9rem;}
</style>
</head>
<body>
<header>
  <img src="lododoc .png" alt="Logo Ventas">
  📜 Historial - FarmaciaLili 3.1 📜 
</header>

<nav class="main-menu">
<a href="farma3.html" class="menu-link ">💳 Ventas</a>
 <a href="inve3.html" class="menu-link">📦 Inventario</a>
 <a href="histori3.html" class="menu-link active">📜 Historial</a>
  
  <div class="dropdown">
    <button class="toggle-btn">📋 Opciones</button>
    <div class="dropdown-content">
      <a href="#" onclick="toggleHistorial()">📂 Historial de ventas 📂</a>
      <a href="#" onclick="toggleHistorialCorte()">📋 Historial de Corte 📋</a>
      <a href="#" onclick="showReimpresionPanel()">🖨️ Reimprimir Ticket 🖨️</a>
    </div>
  </div>
  
  <span id="cajero"></span>
  <button id="logout">Cerrar Sesión</button>
</nav>

<main>
  <section class="card">
    <h2>💵 Ventas Generales </h2>
    <div class="small-muted"> <code></code>  <code></code>.</div>
        <div class="table-container">
      <table id="tabla-ventas-general">
        <thead>
          <tr><th>#</th><th>Código</th><th>Producto</th><th>Cantidad</th><th>Categoría</th><th>Folio Tiket</th><th>Folio Proveedor</th><th>Doctor</th><th>Cédula</th><th>Folio Receta</th><th>Fecha y Hora</th><th>Cajero</th><th>Método de Pago</th><th>Subtotal</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td colspan="12" style="text-align: left; padding: 8px;">
                    <div class="action-row" style="justify-content: flex-start; padding: 0; align-items: baseline;">
                        <label for="inicioCajaTemp" style="font-weight: bold;">Inicio Caja ($):</label>
                        <input id="inicioCajaTemp" type="number" value="0.00" step="0.01" style="width: 80px;" onkeypress="handleInicioCajaKey(event)">
                        <button class="btn-primary btn-save-temp" onclick="guardarInicioCajaTemporal()">💾 Fijar</button>
                    </div>
                </td>
                <td style="text-align: right; font-weight: bold;">Total General</td>
                <td id="total-general" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="12"></td>
                <td style="text-align: right; font-weight: bold;">Total sin Proveedor</td>
                <td id="total-sin-proveedor" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="12"></td>
                <td style="text-align: right; font-weight: bold;">Total Proveedor</td>
                <td id="total-proveedor" style="text-align: right; font-weight: bold;">$0.00</td>
            </tr>
            <tr>
                <td colspan="14" style="text-align: center; padding: 10px 0;">
                    <button class="btn-primary" onclick="abrirModalCorte()">💰 Realizar Corte</button>
                </td>
            </tr>
        </tfoot>
      </table>
    </div>
  </section>

    <section class="card" id="reimpresionPanel" style="display: none;">
        <h2>🖨️ Reimprimir Ticket de Venta</h2>
        <div class="search-container" style="justify-content: flex-start;">
            <input type="text" id="folioReimpresion" class="search-input" placeholder="Ingrese el Folio Tiket (ej: T1234)">
            <button onclick="reimprimirTicketPorFolio()" class="search-btn">Reimprimir</button>
        </div>
        <div id="reimpresionStatus" class="note" style="margin-top: 10px; padding: 10px; border-radius: 5px; background: #fff3cd; color: #856404; display: none;"></div>
    </section>

    <section class="card" id="historialSection">
    <h2>📂 Historial de Ventas Completas 📂</h2>
    <div class="search-container">
      <div>
        <input type="text" id="searchInput" class="search-input" placeholder="Buscar por Folio, Producto, Código, Doctor, etc...">
        <button onclick="buscarHistorial()" class="search-btn">🔍 Buscar</button>
        <button onclick="descargarpdf()" class="clear-btn">descargarPDF</button>
      </div>
    </div>
        <div class="table-container">
      <table id="tabla-historial">
        <thead>
          <tr><th>#</th><th>Código</th><th>Producto</th><th>Cantidad</th><th>Categoría</th><th>Folio Tiket</th><th>Folio Proveedor</th><th>Doctor</th><th>Cédula</th><th>Folio Receta</th><th>Fecha y Hora</th><th>Cajero</th><th>Método de Pago</th><th>Subtotal</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="historialCorteSection">
    <h2>📋 Historial de Corte de Caja Ajustado 📋</h2>
        <div class="table-container">
      <table id="tabla-historial-corte">
        <thead>
          <tr>
            <th>#</th>
             <th>Fecha y Hora</th>
             <th>Cajero</th>
             <th>Inicio Caja</th>
             <th>Total G. Efectivo</th>
             <th>Total G. Tarjeta</th>
             <th>Total G. Transferencia</th>
             <th>Total G. Proveedor</th>
             <th>➕ Entradas</th> 
             <th>➖ Salidas</th> 
             <th>Efectivo Contado</th> 
             <th>Efectivo Neto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<div class="modal" id="modalCorte">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">💵 Panel de Corte</h3>

    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
        <label>💵 Entradas de Efectivo: 
          <input id="entradasEfectivo" type="number" value="0.00" step="0.01" onchange="autorizarMovimiento('entradasEfectivo')">
        </label>
        <label>💸 Salidas de Efectivo: 
          <input id="salidasEfectivo" type="number" value="0.00" step="0.01" onchange="autorizarMovimiento('salidasEfectivo')">
        </label>
    </div>

    <label style="margin-top:8px;">Cantidad Inicio Caja: <input id="inicioCaja" type="number" value="0" step="0.01" readonly style="padding:6px;border-radius:6px;border:1px solid #c7ddff; background-color: #e2e8f0;"></label>
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;">
      <label>💵 1000: <input class="billete" data-valor="1000" type="number" value="0"></label>
      <label>💵 500:  <input class="billete" data-valor="500" type="number" value="0"></label>
      <label>💵 200:  <input class="billete" data-valor="200" type="number" value="0"></label>
      <label>💵 100:  <input class="billete" data-valor="100" type="number" value="0"></label>
      <label>💵 50:   <input class="billete" data-valor="50" type="number" value="0"></label>
      <label>💵 20:   <input class="billete" data-valor="20" type="number" value="0"></label>
      <label>🪙 10:   <input class="billete" data-valor="10" type="number" value="0"></label>
      <label>🪙 5:    <input class="billete" data-valor="5" type="number" value="0"></label>
      <label>🪙 2:    <input class="billete" data-valor="2" type="number" value="0"></label>
      <label>🪙 1:    <input class="billete" data-valor="1" type="number" value="0"></label>
      <label>🪙 0.50: <input class="billete" data-valor="0.5" type="number" value="0"></label>
    </div>

    <div class="total-row">Total Contado (Efectivo en Caja): <span id="totalEfectivoContado">$0.00</span></div>
    
    <div style="margin-top:15px; padding:10px; background:#f0f9ff; border-radius:8px;">
      <h4 style="margin:0 0 10px; color:#1e40af; text-align: center; font-weight: bold;">📊 Resumen de Ventas por Método de Pago:</h4>
      <div style="display:flex; flex-wrap:wrap; gap:15px;">
        <div style="flex:1; min-width:150px;">
            <p style="margin:5px 0; font-weight:bold;">Inicio Caja: <span id="resumenInicioCaja">$0.00</span></p>
          <p style="margin:5px 0; font-weight:bold;">Ventas Efectivo: <span id="resumenEfectivo">$0.00</span></p>
          <p style="margin:5px 0; font-weight:bold;">Ventas Tarjeta: <span id="resumenTarjeta">$0.00</span></p>
        </div>
        <div style="flex:1; min-width:150px;">
          <p style="margin:5px 0; font-weight:bold;">Ventas Transferencia: <span id="resumenTransferencia">$0.00</span></p>
          <p style="margin:5px 0; font-weight:bold;">Ventas Proveedores: <span id="resumenProveedor">$0.00</span></p>
        </div>
      </div>
      
      <hr style="border:0; border-top:1px dashed #c7ddff; margin: 10px 0;">

      <h4 style="margin:0 0 10px; color:#1e40af; text-align: center; font-weight: bold;">💰 Totales Generales Calculados:</h4>
      <div style="display:flex; flex-wrap:wrap; gap:15px; background:#e0f2fe; padding:8px; border-radius:6px;">
        <div style="flex:1; min-width:150px;">
          <p style="margin:5px 0; font-weight:bold; color:#0369a1;">TOTAL EFECTIVO VENTA (V.Efectivo - V.Proveedor): <span id="totalGeneralEfectivo">$0.00</span></p>
          <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL TARJETA: <span id="totalGeneralTarjeta">$0.00</span></p>
        </div>
        <div style="flex:1; min-width:150px;">
          <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL TRANSFERENCIA: <span id="totalGeneralTransferencia">$0.00</span></p>
          <p style="margin:5px 0; font-weight:bold;">TOTAL GENERAL PROVEEDOR: <span id="totalGeneralProveedor">$0.00</span></p>
        </div>
      </div>

      <hr style="border:0; border-top:2px solid #0369a1; margin: 15px 0;">

      <div class="total-row" style="font-size:1.1rem; color:#b91c1c;">
        EFECTIVO NETO (Contado - Esperado): <span id="efectivoNeto">$0.00</span>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
      <button class="btn-primary" onclick="realizarPreCorte()" style="background:#f97316;">🖨️ Pre-Corte</button>
      <button class="btn-primary" onclick="finalizarCorte()">✅ Finalizar Corte e Imprimir</button>
      <button class="btn-secondary" onclick="cerrarModalCorte()">❌ Cerrar</button>
    </div>
  </div>
</div>

<script>
// --- Variables de Configuración ---
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(usuarioActivo){
  document.getElementById("cajero").textContent = "👤 Cajero: " + usuarioActivo;
}

const PASSWORD_CORTE = "1234"; // Contraseña para el historial de corte
const PASSWORD_MOVIMIENTO = "5678"; // Contraseña para entradas/salidas de efectivo

function parseJSON(key){ 
  try{ 
    return JSON.parse(localStorage.getItem(key)||"[]"); 
  }catch(e){ 
    console.warn(`Error al parsear ${key}:`, e);
    return []; 
  } 
}

function setJSON(key,val){ 
  localStorage.setItem(key, JSON.stringify(val)); 
}

function formatDinero(n){ 
  return "$" + (Number(n||0)).toFixed(2); 
}

// Función para cerrar sesión
function cerrarSesion() {
  localStorage.removeItem("usuarioActivo");
  window.location.href = "index.html";
}

document.getElementById("logout").addEventListener("click", cerrarSesion);

// --- Lógica de Ventas y Corte ---

function cargarTodasLasVentas(){
  const ventas = parseJSON('ventas');
  return ventas.filter(venta => venta.productos && venta.productos.length > 0);
}

// ... [El resto de las funciones renderVentas, guardarInicioCajaTemporal, handleInicioCajaKey, etc., permanecen igual]

function renderVentas(){
  // ... (código existente para renderizar ventas generales) ...
  const ventas = cargarTodasLasVentas();
  const tbodyG = document.querySelector("#tabla-ventas-general tbody");
  tbodyG.innerHTML = ""; 
  let totalG = 0;
    let totalSinProveedor = 0; 
    let totalProveedor = 0; 
  let idxG = 1;
  
  ventas.forEach(v=>{
    (v.productos||[]).forEach(item=>{
      const subtotal = (Number(item.precio) || 0) * (Number(item.cantidad) || 0);
      
      // Llenar tabla Ventas Generales
      const trG = document.createElement('tr');
      trG.innerHTML = `<td>${idxG++}</td>
        <td>${item.codigo||'-'}</td>
        <td>${item.nombre||'-'}</td>
        <td>${item.cantidad||0}</td>
        <td>${item.categoria||'-'}</td>
        <td>${v.folio||'-'}</td>
        <td>${v.folioProveedor||'-'}</td>
        <td>${v.clienteNombre||'-'}</td>
        <td>${v.clienteCedula||'-'}</td>
        <td>${v.folioReceta||'-'}</td>
        <td>${v.fecha||'-'}</td>
        <td>${v.metodoPago||'-'}</td>
        <td style="text-align: right;">${formatDinero(subtotal)}</td>`;
      tbodyG.appendChild(trG);
      totalG += subtotal;

      // Cálculo de nuevos totales (Proveedores y Sin Proveedor)
      if (v.metodoPago === 'Proveedores') {
          totalProveedor += subtotal;
      } else {
          totalSinProveedor += subtotal;
      }
    });
  });

  document.getElementById('total-general').textContent = formatDinero(totalG);
    document.getElementById('total-sin-proveedor').textContent = formatDinero(totalSinProveedor);
    document.getElementById('total-proveedor').textContent = formatDinero(totalProveedor);
    
    // Cargar Inicio de Caja temporal en el input de Ventas Generales
    const inicioGuardado = localStorage.getItem('inicioCajaTemporal');
    const inputInicioTemp = document.getElementById('inicioCajaTemp');
    const btnFijar = document.querySelector('.btn-save-temp');
    
    if(inicioGuardado !== null && !isNaN(parseFloat(inicioGuardado))) {
        inputInicioTemp.value = parseFloat(inicioGuardado).toFixed(2);
        inputInicioTemp.readOnly = true;
        inputInicioTemp.style.backgroundColor = '#d1fae5';
        btnFijar.textContent = '✅ Fijado';
        btnFijar.disabled = true;
    } else {
        inputInicioTemp.value = '0.00';
        inputInicioTemp.readOnly = false;
        inputInicioTemp.style.backgroundColor = '';
        btnFijar.textContent = '💾 Fijar';
        btnFijar.disabled = false;
    }
}

function guardarInicioCajaTemporal() {
    const inputInicioTemp = document.getElementById('inicioCajaTemp');
    const btnFijar = document.querySelector('.btn-save-temp');
    const valor = parseFloat(inputInicioTemp.value) || 0;
    
    // Validar y guardar el valor
    localStorage.setItem('inicioCajaTemporal', valor.toFixed(2));
    
    // Fijar la apariencia
    inputInicioTemp.readOnly = true;
    inputInicioTemp.style.backgroundColor = '#d1fae5';
    btnFijar.textContent = '✅ Fijado';
    btnFijar.disabled = true;
    
    alert(`Inicio de Caja ($${valor.toFixed(2)}) guardado y fijado para el corte.`);
}

function handleInicioCajaKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        guardarInicioCajaTemporal();
    }
}
// ... [El resto de las funciones de historial y búsqueda]

function renderHistorialCompleto() {
  const ventasCorte = parseJSON('ventasCorte');
  const tbody = document.querySelector("#tabla-historial tbody");
  tbody.innerHTML = "";
  let idx = 1;
  
  ventasCorte.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx++}</td>
      <td>${item.codigo||'-'}</td>
      <td>${item.producto||'-'}</td>
      <td>${item.cantidad||0}</td>
      <td>${item.categoria||'-'}</td>
      <td>${item.folio||'-'}</td>
      <td>${item.folioProveedor||'-'}</td>
        <td>${item.doctor||'-'}</td>
        <td>${item.cedula||'-'}</td>
        <td>${item.receta||'-'}</td>
        <td>${item.fecha||'-'}</td>
        <td>${item.cajero||'-'}</td>
        <td>${item.metodo||'-'}</td>
        <td style="text-align: right;">${formatDinero(item.subtotal)}</td>`;
    tbody.appendChild(tr);
  });
}

function buscarHistorial() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const ventasCorte = parseJSON('ventasCorte');
    const tbody = document.querySelector("#tabla-historial tbody");
    tbody.innerHTML = "";
    let idx = 1;
    
    ventasCorte.forEach(item => {
        const searchableString = [
            item.producto, item.codigo, item.categoria, item.folio, item.folioProveedor, 
            item.doctor, item.cedula, item.receta, item.fecha, item.cajero, item.metodo,
        ].join(' ').toLowerCase();
        
        if (searchableString.includes(searchTerm)) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx++}</td>
            <td>${item.codigo||'-'}</td>
            <td>${item.producto||'-'}</td>
            <td>${item.cantidad||0}</td>
            <td>${item.categoria||'-'}</td>
            <td>${item.folio||'-'}</td>
            <td>${item.folioProveedor||'-'}</td>
            <td>${item.doctor||'-'}</td>
            <td>${item.cedula||'-'}</td>
            <td>${item.receta||'-'}</td>
            <td>${item.fecha||'-'}</td>
            <td>${item.cajero||'-'}</td>
            <td>${item.metodo||'-'}</td>
            <td style="text-align: right;">${formatDinero(item.subtotal)}</td>`;
            tbody.appendChild(tr);
        }
    });
    
    if (tbody.children.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="14" style="text-align:center; padding:20px;">No se encontraron resultados para "${searchTerm}"</td>`;
        tbody.appendChild(tr);
    }
}

function toggleHistorial() {
  const historialSection = document.getElementById('historialSection');
  const historialCorteSection = document.getElementById('historialCorteSection');
  const reimpresionPanel = document.getElementById('reimpresionPanel');
  
  if (historialSection.style.display === 'none' || historialSection.style.display === '') {
    historialSection.style.display = 'block';
    historialCorteSection.style.display = 'none';
    reimpresionPanel.style.display = 'none';
    renderHistorialCompleto();
  } else {
    historialSection.style.display = 'none';
  }
}

function toggleHistorialCorte() {
    const historialSection = document.getElementById('historialSection');
    const historialCorteSection = document.getElementById('historialCorteSection');
    const reimpresionPanel = document.getElementById('reimpresionPanel');

    if (historialCorteSection.style.display === 'block') {
        historialCorteSection.style.display = 'none';
        return;
    }

    const password = prompt("Ingrese la contraseña para ver el Historial de Corte ");

    if (password === PASSWORD_CORTE) {
        historialCorteSection.style.display = 'block';
        historialSection.style.display = 'none';
        reimpresionPanel.style.display = 'none';
        renderHistorialCorte();
    } else {
        alert("Contraseña incorrecta. Acceso denegado.");
        historialCorteSection.style.display = 'none';
    }
}

function renderHistorialCorte() {
  const cortes = parseJSON('cortes');
  const tbody = document.querySelector("#tabla-historial-corte tbody");
  tbody.innerHTML = "";
  let idx = 1;
  
  cortes.forEach(corte => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx++}</td>
      <td>${corte.fecha||'-'}</td>
      <td>${corte.cajero||'-'}</td>
      <td>${formatDinero(corte.inicioCaja||0)}</td>
      <td>${formatDinero(corte.totalGeneralEfectivo||0)}</td>
      <td>${formatDinero(corte.tarjeta||0)}</td>
      <td>${formatDinero(corte.transferencia||0)}</td>
      <td>${formatDinero(corte.proveedor||0)}</td>
      <td>${formatDinero(corte.entradas||0)}</td> 
      <td>${formatDinero(corte.salidas||0)}</td> 
      <td>${formatDinero(corte.efectivoContado||0)}</td> 
      <td style="text-align: right;">${formatDinero(corte.efectivoNeto||0)}</td>`;
    tbody.appendChild(tr);
  });
}

// ---------- Autorización de Movimiento (NUEVO) ----------

function autorizarMovimiento(idInput) {
    const input = document.getElementById(idInput);
    const newValue = parseFloat(input.value) || 0;
    
    // Solo pedimos contraseña si el nuevo valor es significativo
    if (newValue === 0) {
        calcularTotalEfectivo(false);
        return;
    }

    const password = prompt("Ingrese la contraseña de Gerente/Supervisor para autorizar este movimiento de $"+newValue.toFixed(2)+":");

    if (password === PASSWORD_MOVIMIENTO) {
        calcularTotalEfectivo(false);
    } else {
        alert("Contraseña incorrecta. Movimiento no autorizado. Valor restablecido a 0.00.");
        input.value = '0.00';
        calcularTotalEfectivo(false);
    }
}


// ---------- Modal Corte y Cálculos ----------

function abrirModalCorte(){
  document.getElementById('modalCorte').style.display = 'flex';
  
  // 1. Cargar valor guardado de inicio de caja
  const inicioGuardado = localStorage.getItem('inicioCajaTemporal');
  const inputInicioModal = document.getElementById('inicioCaja');
  
  if(inicioGuardado !== null && !isNaN(parseFloat(inicioGuardado))) {
    inputInicioModal.value = parseFloat(inicioGuardado).toFixed(2);
  } else {
    inputInicioModal.value = '0.00';
  }
  
  // 2. Calcular y mostrar los totales por método de pago INMEDIATAMENTE
  calcularTotalesMetodosPago();
  
  // 3. Reiniciar los campos de billetes y E/S de efectivo
  document.querySelectorAll('.billete').forEach(b => b.value = '0');
  document.getElementById('entradasEfectivo').value = '0.00';
  document.getElementById('salidasEfectivo').value = '0.00';

  document.getElementById('totalEfectivoContado').textContent = '$0.00';
  document.getElementById('efectivoNeto').textContent = '$0.00'; 
}

function cerrarModalCorte(){
  document.getElementById('modalCorte').style.display = 'none';
}

function calcularTotalesMetodosPago(){
  const ventas = cargarTodasLasVentas();
  
  let totalEfectivo = 0;
  let totalTarjeta = 0;
  let totalTransferencia = 0;
  let totalProveedor = 0;
  
  ventas.forEach(v => {
    const metodo = v.metodoPago || 'Efectivo';
    const subtotal = (v.productos || []).reduce((sum, item) => sum + (Number(item.precio || 0) * Number(item.cantidad || 0)), 0);
    
    switch(metodo) {
      case 'Efectivo':
        totalEfectivo += subtotal;
        break;
      case 'Tarjeta':
        totalTarjeta += subtotal;
        break;
      case 'Transferencia':
        totalTransferencia += subtotal;
        break;
      case 'Proveedores':
        totalProveedor += subtotal;
        break;
      default:
        totalEfectivo += subtotal;
    }
  });
  
    const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;

    // Mostrar Resumen
    document.getElementById('resumenInicioCaja').textContent = formatDinero(inicioCaja); 
    document.getElementById('resumenEfectivo').textContent = formatDinero(totalEfectivo);
    document.getElementById('resumenTarjeta').textContent = formatDinero(totalTarjeta);
    document.getElementById('resumenTransferencia').textContent = formatDinero(totalTransferencia);
    document.getElementById('resumenProveedor').textContent = formatDinero(totalProveedor);

    // Totales Generales Calculados
    const totalGeneralEfectivo = totalEfectivo - totalProveedor;

    document.getElementById('totalGeneralEfectivo').textContent = formatDinero(totalGeneralEfectivo);
    document.getElementById('totalGeneralTarjeta').textContent = formatDinero(totalTarjeta);
    document.getElementById('totalGeneralTransferencia').textContent = formatDinero(totalTransferencia);
    document.getElementById('totalGeneralProveedor').textContent = formatDinero(totalProveedor);

    calcularTotalEfectivo(true);
}

function calcularTotalEfectivo(skipUpdateMetodosPago = false) {
  const billetes = document.querySelectorAll('.billete');
  let totalEContado = 0;
  billetes.forEach(b => {
    totalEContado += Number(b.value || 0) * Number(b.dataset.valor || 0);
  });
  document.getElementById('totalEfectivoContado').textContent = formatDinero(totalEContado);

  const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;
  const entradas = parseFloat(document.getElementById('entradasEfectivo').value) || 0;
  const salidas = parseFloat(document.getElementById('salidasEfectivo').value) || 0;
  
  const efectivoVentas = parseFloat(document.getElementById('resumenEfectivo').textContent.replace('$', '')) || 0;
  const totalProveedor = parseFloat(document.getElementById('resumenProveedor').textContent.replace('$', '')) || 0;
  
  // Lo que debería haber en caja para cuadrar: Inicio + (Ventas Efectivo - V.Proveedor) + Entradas - Salidas
  const efectivoEsperado = inicioCaja + (efectivoVentas - totalProveedor) + entradas - salidas;

  // Diferencia (Efectivo Neto) para cuadre: Contado - Esperado
  const diferenciaCuadre = totalEContado - efectivoEsperado;
  
  document.getElementById('efectivoNeto').textContent = formatDinero(diferenciaCuadre); 
}

document.querySelectorAll('.billete').forEach(b => {
  b.addEventListener('input', () => calcularTotalEfectivo(false)); 
});
// La autorización ya maneja el cálculo después de la validación
document.getElementById('entradasEfectivo').addEventListener('input', () => {
  const input = document.getElementById('entradasEfectivo');
  if (parseFloat(input.value) === 0) calcularTotalEfectivo(false);
});
document.getElementById('salidasEfectivo').addEventListener('input', () => {
  const input = document.getElementById('salidasEfectivo');
  if (parseFloat(input.value) === 0) calcularTotalEfectivo(false);
});


// ---------- Lógica de Pre-Corte (NUEVO) ----------

function realizarPreCorte(){
  const data = obtenerDatosCorte();
  if (!data) return; // Si hay error en la data, no procedemos.

  imprimirTicketCorte(
    data.inicioCaja, 
    data.efectivoContado, 
    data.tarjeta, 
    data.transferencia, 
    data.proveedor, 
    data.totalGeneral,
    data.efectivoVentas, 
    data.totalGeneralEfectivo, 
    data.efectivoNeto,
    data.entradas, 
    data.salidas,
    "PRE-CORTE" // Bandera para el título
  );

  alert('Pre-Corte realizado. Ticket impreso. Los datos NO han sido guardados ni borrados.');
  // No hay cierre de sesión ni borrado de ventas
}

// ---------- Lógica de Corte Final ----------

function obtenerDatosCorte() {
    // 1. Valores de entrada y conteo
    const inicioCaja = parseFloat(document.getElementById('inicioCaja').value) || 0;
    const entradas = parseFloat(document.getElementById('entradasEfectivo').value) || 0;
    const salidas = parseFloat(document.getElementById('salidasEfectivo').value) || 0;
    
    const billetes = document.querySelectorAll('.billete');
    let efectivoContado = 0;
    billetes.forEach(b => efectivoContado += Number(b.value || 0) * Number(b.dataset.valor || 0));
    
    // 2. Totales de Ventas (Tomados del resumen)
    const efectivoVentas = parseFloat(document.getElementById('resumenEfectivo').textContent.replace('$', '')) || 0;
    const tarjeta = parseFloat(document.getElementById('resumenTarjeta').textContent.replace('$', '')) || 0;
    const transferencia = parseFloat(document.getElementById('resumenTransferencia').textContent.replace('$', '')) || 0;
    const proveedor = parseFloat(document.getElementById('resumenProveedor').textContent.replace('$', '')) || 0;
    
    // 3. Totales Generales Calculados
    const totalGeneralEfectivo = efectivoVentas - proveedor;
    const totalGeneral = totalGeneralEfectivo + tarjeta + transferencia;

    // Cálculo del Efectivo Neto (Diferencia para el cuadre)
    const efectivoEsperado = inicioCaja + totalGeneralEfectivo + entradas - salidas;
    const efectivoNeto = efectivoContado - efectivoEsperado; 

    return {
        inicioCaja, efectivoContado, efectivoVentas, tarjeta, transferencia, proveedor, totalGeneralEfectivo, totalGeneral, efectivoNeto, entradas, salidas
    };
}

function finalizarCorte(){
  const data = obtenerDatosCorte();
  if (!data) return;

  // Guardar el corte
  const cortes = parseJSON('cortes');
  cortes.push({
    fecha: new Date().toLocaleString(), 
    cajero: usuarioActivo, 
    ...data // Esparce todos los datos calculados en el objeto corte
  });
  setJSON('cortes', cortes);

  const ventas = cargarTodasLasVentas(); 
  const ventasCorte = parseJSON('ventasCorte');
  
  // Mover las ventas activas al historial (Lógica actual: mover productos individuales)
  ventas.forEach(v => {
    v.productos.forEach(item => {
      ventasCorte.push({
        producto: item.nombre,
        codigo: item.codigo,
        cantidad: item.cantidad,
        categoria: item.categoria || '', 
        folio: v.folio, 
        folioProveedor: v.folioProveedor || '', 
        doctor: v.clienteNombre || '', 
        cedula: v.clienteCedula || '', 
        receta: v.folioReceta || '', 
        fecha: v.fecha, 
        cajero: v.cajero,
        metodo: v.metodoPago, 
        subtotal: (item.precio * item.cantidad) 
      });
    });
  });
  
  setJSON('ventasCorte', ventasCorte);

  // Vaciar solo la clave de ventas activas 'ventas'
  localStorage.setItem('ventas', JSON.stringify([]));

  // Limpiar inicio de caja temporal y el input de la página (resetear el estado de fijado)
  localStorage.removeItem('inicioCajaTemporal');
  document.getElementById('inicioCajaTemp').value = '0.00';
  document.getElementById('inicioCajaTemp').readOnly = false;
  document.getElementById('inicioCajaTemp').style.backgroundColor = '';
  document.querySelector('.btn-save-temp').textContent = '💾 Fijar';
  document.querySelector('.btn-save-temp').disabled = false;


  // Imprimir ticket
  imprimirTicketCorte(
    data.inicioCaja, 
    data.efectivoContado, 
    data.tarjeta, 
    data.transferencia, 
    data.proveedor, 
    data.totalGeneral,
    data.efectivoVentas, 
    data.totalGeneralEfectivo, 
    data.efectivoNeto,
    data.entradas, 
    data.salidas,
    "CORTE FINAL" // Bandera para el título
  );

  cerrarModalCorte();
  
  renderVentas();
  
  // Cerrar sesión
  cerrarSesion();
}

/**
 * Genera e imprime un ticket con el resumen del corte de caja.
 * @param {string} tipo Tipo de corte: "CORTE FINAL" o "PRE-CORTE".
 */
function imprimirTicketCorte(inicioCaja, efectivoContado, tarjeta, transferencia, proveedor, totalGeneral, efectivoVentas, totalGeneralEfectivo, efectivoNeto, entradas, salidas, tipo) {
  const ventana = window.open("","Ticket","width=300,height=600");
  const fecha = new Date().toLocaleString();
  
  // Cálculo de cuadre para el ticket
  const efectivoEsperado = inicioCaja + efectivoVentas - proveedor + entradas - salidas;
  const diferenciaCuadre = efectivoContado - efectivoEsperado;

  let html = `<html><head><title>Ticket de ${tipo}</title>
  <style>
    body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; background-color: #fff; color: #000; font-size: 10px; line-height: 1.2; width: 2.2in; margin: 0 auto; }
    .ticket-header { text-align: center; padding: 5px 0; border-bottom: 1px solid #000; margin-bottom: 10px; }
    .ticket-header h2 { margin: 3px 0; font-size: 14px; color: #000; }
    .ticket-header p { margin: 2px 0; font-size: 9px; }
    .info-container { display: flex; justify-content: space-between; margin: 8px 0; font-size: 10px; }
    .resumen-row { font-weight: bold; margin: 5px 0; }
    .footer { text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #000; font-style: italic; color: #000; font-size: 9px; }
  </style>
  </head><body>
  <div class="ticket-header">
    <h2>[ ${tipo} ]</h2>
    <p>💊 FarmaciaLili - Corte 💊</p>
    <p>Fecha: ${fecha}</p>
    <p>Cajero: ${usuarioActivo}</p>
  </div>
  
  <div style="border-top: 1px solid #000; margin: 8px 0;"></div>

  <div class="resumen-row">
    <p>💰 **EFECTIVO CONTADO:** ${formatDinero(efectivoContado)}</p>
    <p>💲 Inicio Caja: ${formatDinero(inicioCaja)}</p>
    <p style="color: ${diferenciaCuadre !== 0 ? 'red' : 'green'};">**DIFERENCIA (Contado - Esperado):** ${formatDinero(diferenciaCuadre)}</p>
  </div>

  <div style="border-top: 1px solid #000; margin: 8px 0;"></div>

  <div class="resumen-row">
    <p>📊 **MOVIMIENTOS DE CAJA**</p>
    <p>Ventas Efectivo: ${formatDinero(efectivoVentas)}</p>
    <p>➕ Entradas Efectivo: ${formatDinero(entradas)}</p>
    <p>➖ Salidas Efectivo: ${formatDinero(salidas)}</p>
    <p style="border-top: 1px solid #ddd; padding-top: 3px;">**EFECTIVO ESPERADO (Contado):** ${formatDinero(efectivoEsperado)}</p>
  </div>

  <div style="border-top: 1px solid #000; margin: 8px 0;"></div>

  <div class="resumen-row">
    <p>⭐ **TOTALES GENERALES**</p>
    <p>TOTAL VENTA EFECTIVO (V.Efectivo - V.Proveedor): ${formatDinero(totalGeneralEfectivo)}</p>
    <p>TOTAL VENTA TARJETA: ${formatDinero(tarjeta)}</p>
    <p>TOTAL VENTA TRANSFERENCIA: ${formatDinero(transferencia)}</p>
    <p>TOTAL VENTA PROVEEDOR: ${formatDinero(proveedor)}</p>
    <p style="border-top: 1px solid #000; padding-top: 3px;">**TOTAL VENTA DÍA:** ${formatDinero(totalGeneral)}</p>
  </div>
  
  <br>
  <div class="footer">
    <p> ${tipo === 'CORTE FINAL' ? '✅ Corte Finalizado ✅' : '❕ Esto es un Pre-Corte ❕'} </p>
    <p> 🩺 Gracias por su confianza 🩺 </p>
  </div>
  </body></html>`;
  
  ventana.document.write(html);
  ventana.document.close();
  ventana.print();
}


// ---------- Lógica de Reimpresión de Tickets (NUEVO) ----------

function showReimpresionPanel() {
    const reimpresionPanel = document.getElementById('reimpresionPanel');
    const historialSection = document.getElementById('historialSection');
    const historialCorteSection = document.getElementById('historialCorteSection');

    historialSection.style.display = 'none';
    historialCorteSection.style.display = 'none';
    reimpresionPanel.style.display = 'block';
    document.getElementById('reimpresionStatus').style.display = 'none';
}

function reimprimirTicketPorFolio() {
    const folio = document.getElementById('folioReimpresion').value.trim();
    const statusDiv = document.getElementById('reimpresionStatus');
    statusDiv.style.display = 'block';

    if (!folio) {
        statusDiv.textContent = "❌ Por favor, ingrese un número de Folio Tiket.";
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        return;
    }

    const ventasCorte = parseJSON('ventasCorte');
    
    // 1. Agrupar items por Folio
    const itemsVenta = ventasCorte.filter(item => item.folio === folio);

    if (itemsVenta.length === 0) {
        statusDiv.textContent = `❌ Folio Tiket "${folio}" no encontrado en el historial.`;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        return;
    }

    // 2. Reconstruir los datos de la venta para el ticket (usando el primer elemento como base)
    const baseVenta = itemsVenta[0];
    let subtotalTotal = 0;
    
    const productosReimpresion = itemsVenta.map(item => {
        const itemTotal = item.cantidad * item.subtotal; // Nota: subtotal en ventasCorte es el precio unitario
        subtotalTotal += itemTotal;
        return {
            nombre: item.producto,
            cantidad: item.cantidad,
            precio: item.subtotal, 
            total: itemTotal
        };
    });
    
    // 3. Imprimir el ticket de venta
    imprimirTicketVenta(baseVenta, productosReimpresion, subtotalTotal);

    statusDiv.textContent = `✅ Ticket de Folio "${folio}" reimpreso con éxito.`;
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
}

function imprimirTicketVenta(baseVenta, productos, total) {
    const ventana = window.open("", "TicketVenta", "width=300,height=600");
    
    let itemsHtml = productos.map(p => `
        <div style="display:flex; justify-content:space-between;">
            <span>${p.cantidad} x ${p.nombre.substring(0, 20)}</span>
            <span>${formatDinero(p.total)}</span>
        </div>
        <div style="text-align:right; font-size:9px;">(${formatDinero(p.precio)} c/u)</div>
    `).join('');

    let html = `<html><head><title>Ticket Venta</title>
    <style>
      body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; background-color: #fff; color: #000; font-size: 10px; line-height: 1.2; width: 2.2in; margin: 0 auto; }
      .ticket-header { text-align: center; padding: 5px 0; border-bottom: 1px solid #000; margin-bottom: 10px; }
      .ticket-header h2 { margin: 3px 0; font-size: 14px; color: #000; }
      .info-container { margin: 8px 0; font-size: 10px; }
      .resumen-row { font-weight: bold; margin: 5px 0; }
      .footer { text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #000; font-style: italic; color: #000; font-size: 9px; }
    </style>
    </head><body>
    <div class="ticket-header">
        <h2>REIMPRESIÓN TICKET</h2>
        <p>Folio: ${baseVenta.folio}</p>
        <p>Fecha: ${baseVenta.fecha}</p>
        <p>Cajero: ${baseVenta.cajero}</p>
    </div>
    
    <div class="info-container">
        <p style="border-bottom: 1px dashed #000;">** DETALLE DE LA VENTA **</p>
        ${itemsHtml}
    </div>

    <div style="border-top: 1px solid #000; margin: 8px 0;"></div>

    <div class="resumen-row" style="text-align:right;">
        <p>SUBTOTAL: ${formatDinero(total)}</p>
        <p>IVA (Asumido 0%): ${formatDinero(0)}</p>
        <p style="font-size: 14px; border-top: 1px dashed #000;">TOTAL: ${formatDinero(total)}</p>
    </div>
    
    <div class="footer">
        <p>Método de Pago: ${baseVenta.metodo}</p>
        <p>🩺 Gracias por su preferencia 🩺</p>
    </div>
    </body></html>`;
    
    ventana.document.write(html);
    ventana.document.close();
    ventana.print();
}

// Inicialización
renderVentas();
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('searchInput').addEventListener('input', function() {
    if (this.value.trim() === '') {
      renderHistorialCompleto();
    } else {
      buscarHistorial();
    }
  });
});
</script>
</body>
</html>
